package com.lenovo.ailab.smartedge.service;

import java.io.*;
import java.lang.reflect.Array;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.List;
import java.util.stream.Collectors;

import org.apache.commons.codec.binary.Base64;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.mock.web.MockMultipartFile;
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.google.common.collect.Lists;
import com.lenovo.ailab.smartedge.common.CommonParams;
import com.lenovo.ailab.smartedge.config.CompressionFile;
import com.lenovo.ailab.smartedge.config.ParseCompressedFile;
import com.lenovo.ailab.smartedge.config.RedisHelper;
import com.lenovo.ailab.smartedge.config.TreeConfig;
import com.lenovo.ailab.smartedge.controller.DeviceController;
import com.lenovo.ailab.smartedge.dao.*;
import com.lenovo.ailab.smartedge.dao.po.*;
import com.lenovo.ailab.smartedge.dao.vo.*;
import com.lenovo.ailab.smartedge.utils.ResponseModel;
import com.lenovo.ailab.smartedge.utils.TimeUtil;
import org.apache.commons.lang3.StringUtils;
import org.apache.http.entity.ContentType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cache.annotation.CacheConfig;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.CachePut;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.cache.annotation.Caching;
import org.springframework.stereotype.Service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lenovo.ailab.smartedge.domain.PageRequest;
import com.lenovo.ailab.smartedge.domain.PageResult;
import com.lenovo.ailab.smartedge.utils.PageUtils;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.client.RestTemplate;

import javax.servlet.http.HttpServletResponse;


/**
 * Title: DepartmentServiceImpl.java
 * 
 * @Autohr "chenpeng"
 * @data 2019年12月3日
 * @Email chenpeng10@lenovo.com
 * @description:
 **/
@Service
@CacheConfig(cacheNames = "depment")
public class DepartmentServiceImpl implements DepartmentService {
    private static final Logger logger = LoggerFactory.getLogger(DeviceController.class);
	@Autowired
	DepartmentMapper departmentMapper;
	@Autowired
	DepartmentDeviceMapper deviceMapper;
	@Autowired
	DepartmentDeviceTopologyMapper topologyMapper;
	@Autowired
	EdgeDeviceService edgeDeviceService;
    @Autowired
    OperatingSystemMapper osystemMapper;
    @Autowired
    HardwareMapper hardwareMapper;
    @Autowired
    EdgeDeviceMapper edgeDeviceMapper;
    @Autowired
    SoftwareMapper softwareMapper;
    @Autowired
    EdgeDeviceHardwareMapper deviceHardwareMapper;
    @Autowired
    EdgeDeviceSoftwareMapper edgeDeviceSoftwareMapper;
    @Autowired
	EdgeServiceImpl edgeServiceImpl;
    @Autowired
    private RestTemplate restTemplate;
    @Value("${token.url}")
    String GET_JWT_TOKEN_URL;
    @Autowired
    private RedisHelper redisHelper;
    @Autowired
    ResourceServiceImpl resourceServiceImpl;
    @Value("${controlServer.url}")
    String CONTROL_SERVER_INIT;
    @Value("${face.server-url}")
    String FACE_SERVER;

	@Override
	/*@Caching(evict = { @CacheEvict(cacheNames = "department", key = "#id"),
			@CacheEvict(cacheNames = "allDepartment", allEntries = true) })*/
	@Transactional(rollbackFor = Exception.class)
	public int deleteDepartmentById(Integer id) {
	    // 1.删除店铺<手动设置为负值>
        //String code = "-" + id;
        int result = departmentMapper.deleteByPrimaryKey(id);
        // 2.删除相关配置单
        deviceMapper.deleteByPrimaryKey(id);
        return result;
	}

	@Override
	//@CacheEvict(cacheNames = "allDepartment", allEntries = true)
	public ResponseModel insertDepartment(Department record) {
	    // 1.code不能为空
	    if(StringUtils.isBlank(record.getBtitdCode())){
	        return ResponseModel.fail("code 不能为空 ！",-1);
        }
        // 2.code 不能重复
        Department department = departmentMapper.selectByBtitDepartmentCode(record.getBtitdCode());
        if(null != department){
            return ResponseModel.fail("code 已存在 ！",-1);
        }
        int id = departmentMapper.insert(record);
        // 3.创建人脸注册组
       // addFaceGroupFromParam(record);
        record.setId(record.getId());
        return ResponseModel.ok(record);
	}

    public ResponseModel addFaceGroupFromParam(Department record) {
	    try{
            // 1.创建组
            // 1.1 查询库 aimine的id
            ResponseModel responseModel = restTemplate.getForObject(FACE_SERVER + "/rest/cv/facelibraryraries/developerLibraries?keyword=aimachine&page=1&limit=10",
                    ResponseModel.class);
            HashMap<String,Object> hashMapForData = (HashMap<String, Object>) responseModel.getResult();
            List<FaceOfLibrary> faceOfLibraryList = (List<FaceOfLibrary>) hashMapForData.get("data");
            if(null == faceOfLibraryList){
                return ResponseModel.fail("人脸库为空！",-1);
            }
            String s = JSONArray.toJSONString(faceOfLibraryList);
            List<FaceOfLibrary> faceOfLibraries = JSONArray.parseArray(s, FaceOfLibrary.class);
            FaceOfLibrary faceOfLibrary = faceOfLibraries.get(0);
            Integer libId = faceOfLibrary.getId();
            // 1.2 创建组
            HashMap<String, Object> hashMap = new HashMap<>();
            hashMap.put("description","smartstore-operation");
            hashMap.put("libId",libId);
            hashMap.put("name",record.getBtitdCode());

            ResponseModel responseResult = restTemplate.postForObject(FACE_SERVER + "/rest/cv/facegroups",
                    hashMap, ResponseModel.class);
            HashMap<String, Object> hashMap2 = new HashMap<>();
            hashMap2.put("description","smartstore-operation");
            hashMap2.put("libId",libId);
            hashMap2.put("name",record.getBtitdCode()+"_member");

            ResponseModel responseResult2 = restTemplate.postForObject(FACE_SERVER + "/rest/cv/facegroups", hashMap2, ResponseModel.class);

            HashMap<String, Object> hashMap3 = new HashMap<>();
            hashMap3.put("description","smartstore-operation");
            hashMap3.put("libId",libId);
            hashMap3.put("name",record.getBtitdCode()+"_clerk");

            ResponseModel responseResult3 = restTemplate.postForObject(FACE_SERVER + "/rest/cv/facegroups", hashMap3, ResponseModel.class);
            /*if(responseResult3.getStatus() != 0 || responseResult2.getStatus() != 0 || responseResult.getStatus() != 0){
                return ResponseModel.fail("insert face of group error！",-1);
            }*/
            String personId = String.valueOf(System.currentTimeMillis());
            // 2.创建用户选择组
            // 2.1 查询组
            ResponseModel responseResult5 = restTemplate.getForObject(FACE_SERVER + "/rest/cv/facegroups/names",
                    ResponseModel.class);
            String s1 = JSONArray.toJSONString(responseResult5.getResult());
            if(StringUtils.isBlank(s1)){
                return ResponseModel.fail("select face of group list is null！",-1);
            }
            List<GroupBean> groupBeans = JSONArray.parseArray(s1, GroupBean.class);
            List<String> ids = new ArrayList<>();

            for(GroupBean groupBean1: groupBeans){
                if(groupBean1.getGroupName().equals(record.getBtitdCode()) || groupBean1.getGroupName().equals(record.getBtitdCode() + "_member")
                        || groupBean1.getGroupName().equals(record.getBtitdCode() + "_clerk")){
                    ids.add(groupBean1.getGroupName());
                }
            }
            if(null == ids){
                return ResponseModel.fail("select face of group list is null！",-1);
            }
            Object[] objects = ids.toArray();
            HashMap<String, Object> hashMap1 = new HashMap<>();
            hashMap1.put("description","smartstore-operation");
            hashMap1.put("groupNames",objects);
            hashMap1.put("name",record.getBtitdCode());
            hashMap1.put("personId",personId);
            //  2.2 创建用户（保存用户和组的关系）
            ResponseModel responseResult6 = restTemplate.postForObject(FACE_SERVER + "/rest/cv/face/persons",
                    hashMap1, ResponseModel.class);
            if(responseResult6.getStatus() != 0){
                return ResponseModel.fail("insert user error！",-1);
            }
            // 3.上传头像
            List<String> base64Datas = new ArrayList<>();
            base64Datas.add("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");
            ResponseModel responseResult4 = restTemplate.postForObject(FACE_SERVER + "/rest/cv/face/persons/"+personId+"/images",
                    base64Datas, ResponseModel.class);
            if(responseResult4.getStatus() != 0){
                return ResponseModel.fail("upload user image error！",-1);
            }
        }catch (Exception e){
            logger.error(e.toString());
        }
        return ResponseModel.ok("success");
    }

	/**
	 * @about  department detail
	 * @param id
	 * @return
	 */
    @Override
    //@Cacheable(cacheNames = "department", key = "#id")
    public Department selectDepartmentById(Integer id) {
        Department department = departmentMapper.selectByPrimaryKey(id);
        int edgeDeviceNum = 0;
        int endDeviceNum = 0;
        int normalDeviceNum = 0;
        int offNormalDeviceNum = 0;
        if (null != department) {
            List<DepartmentDevice> departmentDevices = selectDepartmentDeviceBydepartmentId(department.getId());
            if(null != departmentDevices && departmentDevices.size() > 0){
                for(DepartmentDevice departmentDevice : departmentDevices){
                    if(CommonParams.EDGE_TYPE_END.equals(departmentDevice.geteType())){
                        endDeviceNum++;
                    }else{
                        edgeDeviceNum++;
                    }
                    if(departmentDevice.getStatus() == 0){
                        normalDeviceNum++;
                    }else{
                        offNormalDeviceNum++;
                    }
                }
            }
            department.setEdgeDeviceNum(edgeDeviceNum);
            department.setEndDeviceNum(endDeviceNum);
            department.setDepartmentDeviceList(departmentDevices);
            department.setDepartmentDeviceTopologyList(selectAllDepartmentTopologyByDepartmentId(department.getId()));
            // 门店是否配置配置单/完成拓扑图构建
            setDepartmentIsConfig(department,departmentDevices);
            department.setOffNormalDeviceNum(offNormalDeviceNum);
            department.setNormalDeviceNum(normalDeviceNum);
            department.setDepartmentDeviceTypeNum(2);
            department.setDepartmentAllDeviceNum(offNormalDeviceNum + normalDeviceNum);
        }

        return department;
    }



    /**
     * @about  department detail
     * @param departmentCode
     * @param type
     * @return
     */
    @Override
    //@Cacheable(cacheNames = "department", key = "#id")
    public Department selectByBtitDepartmentCode(String departmentCode,String type) {
        Department  department = departmentMapper.selectByBtitDepartmentCode(departmentCode);
        List<DepartmentDevice> departmentDevicesResult = new ArrayList<>();
        if (null != department) {
            List<DepartmentDevice> departmentDevices = selectDepartmentDeviceBydepartmentId(department.getId());
            if(null != departmentDevices && departmentDevices.size() > 0){
                for(DepartmentDevice departmentDevice : departmentDevices){
                    if(departmentDevice.geteType().equals(type)){
                        departmentDevicesResult.add(departmentDevice);
                    }
                }
            }
            department.setDepartmentDeviceList(departmentDevicesResult);
            department.setDepartmentDeviceTopologyList(selectAllDepartmentTopologyByDepartmentId(department.getId()));
            // 门店是否配置配置单/完成拓扑图构建
            setDepartmentIsConfig(department,departmentDevices);
        }

        return department;
    }

    /**
     * @param pageRequest
     * @param tenant
     * @param shopCode
     * @return 设备列表 for btit code
     */
    @Override
    public PageResult<DepartmentDeviceForBtit> getDeviceListForPage(PageRequest pageRequest, Integer tenant,String shopCode, String status, String type) {
        int pageNum = pageRequest.getPageNum();
        int pageSize = pageRequest.getPageSize();
        PageHelper.startPage(pageNum, pageSize);
        List<DepartmentDeviceForBtit> sysMenus = getAllDeviceListForPage(tenant, shopCode, status, type);
        return PageUtils.getPageResult(pageRequest, new PageInfo<DepartmentDeviceForBtit>(sysMenus));
    }

    @Override
    public List<CameraInstallStatusVo> getAllCameraInstallStatus(Integer departmentId) {
        return deviceMapper.getAllCameraInstallStatus(departmentId);
    }

    /**
     * @param deviceId
     * @param imageId
     * @return 修改安装状态
     */
    @Override
    public ResponseModel updateCameraInstallStatus(Integer deviceId, String imageId,Integer status) {
        // 1.查询最新安装图片的id,如相同说明可操作
        DepartmentDevice departmentDevice = deviceMapper.selectByPrimaryKey(deviceId);

        if(null != departmentDevice){
            if(imageId.equals(departmentDevice.getInstallTheImageId())){
               deviceMapper.updateCameraInstallStatus(deviceId, status);
            }else{
                return ResponseModel.fail(CommonParams.INSTALL_IMAGE_STATUS,1);
            }
        }
       return ResponseModel.ok(status);
    }

    //判断Object 的类型(map,set,list,array),并返回长度
    public static int getLength(Object obj) {
        if (obj == null) {
            return 0;
        }
        if (obj.getClass().isArray()){
            int length = Array.getLength(obj);
            return length;
        }if (obj instanceof List) {
            return ((List) obj).size();
        }if (obj instanceof Set) {
            return ((Set) obj).size();
        }if (obj instanceof Map) {
            return ((Map) obj).size();
        }
        return 0;
    }
    /**
     * @param departmentId
     * @return 获取门店摄像头分布情况
     */
    @Override
    public EquipmentDeploymentDetails getAllDeviceDistribution(Integer departmentId) {
        EquipmentDeploymentDetails deploymentDetails = new EquipmentDeploymentDetails();
        deploymentDetails.setDepartmentId(departmentId);

        List<CameraInstallVo> cameraInstallVoList = new ArrayList<>();
        List<CameraDetailVo> cameraDetailVos = new ArrayList<>();
        List<CameraDetailForLandMarksVo> cameraDetailForLandMarks = new ArrayList<>();


        // 1.获取门店部署文件 - 摄像头安装图片 - 画线数据
        selectLineList(departmentId,cameraInstallVoList);
        // 2.获取最新门店设备部署文件
        List<HardwareDeploymentFile> deploymentFile = deviceMapper.getDeploymentFile(departmentId);
        String urlFile = "";
        if(null != deploymentFile && deploymentFile.size() > 0){
            urlFile = deploymentFile.get(0).getDeploymentFilePath();
        }
        try {
            String fileContent = ParseCompressedFile.readData(urlFile, CommonParams.DOWNLOAD_INSTALL_FILE);
           // logger.info("Device Deployment File Url is {} , Content is {} ",urlFile,fileContent);
            if(StringUtils.isNotBlank(fileContent)){
                Map<String,String> jsonObject = JSON.parseObject(fileContent , Map.class);
                Object cameras = jsonObject.get("Cameras"); // 摄像头
                Object landMarks = jsonObject.get("LandMarks"); // 地标

                cameraDetailVos = JSONArray.parseArray(cameras.toString(), CameraDetailVo.class);
                cameraDetailForLandMarks = JSONArray.parseArray(landMarks.toString(), CameraDetailForLandMarksVo.class);
            }

        } catch (IOException e) {
            e.printStackTrace();
        }

        deploymentDetails.setCameraDetailVoList(cameraDetailVos);
        deploymentDetails.setCameraDetailForLandMarksVoList(cameraDetailForLandMarks);
        deploymentDetails.setCameraInstallImage(cameraInstallVoList);
        return deploymentDetails;
    }

    /*public static void main (String[] args) throws IOException {
        String fileContent = ParseCompressedFile.readData("https://dev-api.brain.lenovo.com/file/static/fad229bc9486441f82b825d409016ee5", "smartstore/config.yaml");
        System.out.println(fileContent+"=============");
    }*/
    /**
     * @param departmentId
     * @param cameraInstallVoList
     * @about 获取划线数据
     */
    public void selectLineList(Integer departmentId,  List<CameraInstallVo> cameraInstallVoList){
        // 1.获取门店的安装校对图
        List<DepartmentDeviceForBtit> departmentDeviceList = deviceMapper.selectDeviceByDepartmentId(departmentId, CommonParams.EDGE_TYPE_END);
        // 2.获取门店部署文件 - 摄像头安装图片 - 画线数据
        HashMap<String, Object> hashMap2 = selectDepartmentInstallFile(departmentId,null);
        // 删除下载包
        System.gc();
        CompressionFile.delFolder(CommonParams.INSTALL_DEPLOYMENT_FILE_COMPRESSIONFILE);
        if(null != departmentDeviceList && departmentDeviceList.size() > 0){
            for(DepartmentDeviceForBtit departmentDevice : departmentDeviceList){
                CameraInstallVo cameraInstallVo = new CameraInstallVo();
                cameraInstallVo.setCameraID(departmentDevice.getId());
                cameraInstallVo.setCoverageAreaImage(departmentDevice.getCoverageAreaImage());
                cameraInstallVo.setInstallTheImage(departmentDevice.getInstallTheImage());
                cameraInstallVo.setInstallStatus(departmentDevice.getInstallStatus());
                cameraInstallVo.setInstallTheImageId(departmentDevice.getInstallTheImageId());
                // 获取摄像头画图线数据
               /* if(null != hashMap2.get(departmentDevice.getId().toString())){
                    HashMap<String, Object> oldValue = JSONObject.parseObject(hashMap2.get(departmentDevice.getId().toString()).toString(), HashMap.class);
                    if(null != oldValue.get("lineList")){
                        List<CameraCoordinates> lineList = JSONArray.parseArray(oldValue.get("lineList").toString(), CameraCoordinates.class);
                        cameraInstallVo.setLineList(lineList);
                    }
                }*/
                // 获取摄像头画图线数据  TODO 以前是media.json 现在是paintermap.json
                if(null != hashMap2.get(CommonParams.ENTER_OR_PASSING_LINES)){
                    HashMap<String, Object> oldValue = JSONObject.parseObject(hashMap2.get(CommonParams.ENTER_OR_PASSING_LINES).toString(), HashMap.class);
                    if(!oldValue.keySet().isEmpty()&& oldValue.containsKey(departmentDevice.getId().toString())){
                        List<CameraCoordinates> lineList = JSONArray.parseArray(oldValue.get(departmentDevice.getId().toString()).toString(), CameraCoordinates.class);
                        cameraInstallVo.setLineList(lineList);
                    }
                }
                cameraInstallVoList.add(cameraInstallVo);
            }
        }
    }
    /**
     * @param departmentId
     * @return 获取部署文件的数据 --画线数据
     */
    public HashMap<String, Object> selectDepartmentInstallFile(Integer departmentId,String filePath){
        long randomNum = System.currentTimeMillis();
        HashMap<String, Object> hashMap2 = new HashMap<>();

        // 1.获取门店部署文件 - 摄像头安装图片 - 画线数据
        String filePathResult = "";
        if(null != filePath && !"".equals(filePath)){
            filePathResult = filePath;
        }else{
            List<HardwareDeploymentFile> deploymentFileList = deviceMapper.getDeploymentFile(departmentId);
            if(null != deploymentFileList && deploymentFileList.size() > 0){
                filePathResult = deploymentFileList.get(0).getDeploymentFilePath();
            }
        }
        logger.info("getImageFromURL filePath is {},",filePathResult);
        if(StringUtils.isNotBlank(filePathResult)){
            // 2.下载并解压
            byte[] imageFromURL = CompressionFile.getImageFromURL(filePathResult);
            File file = CompressionFile.getFileByBytes(imageFromURL,
                    CommonParams.INSTALL_DEPLOYMENT_FILE_COMPRESSIONFILE, randomNum+CommonParams.INSTALL_DEPLOYMENT_FILE_TEST);
            // 3.解析并追加
            if(null != file) {
                try {
                    if (!file.exists()) {
                        file.createNewFile();
                    }
                    FileVo fileVo = CompressionFile.UnZipFolder(file.getAbsolutePath(),
                            CommonParams.INSTALL_DEPLOYMENT_FILE_COMPRESSIONFILE + File.separator);
                    if (null != fileVo) {
                        logger.info(" media.json is {}", fileVo.getWrite());
                        String replace = fileVo.getWrite().replace("}\n" +
                                "{", ",");
                        hashMap2 = JSONObject.parseObject(replace, HashMap.class);
                    }
                }catch(Exception e){
                    logger.info("have an Exception for Read camera data");
                }
            }
        }

        return hashMap2;
    }
    /**
     * @param code
     * @return 服务端获取设备类型
     */
    @Override
    public List<DepartmentDeviceForUseType> selectCameraDepartmentByCode(String code) {
        List<DepartmentDeviceForUseType> deviceForType = new ArrayList<>();
        Department department = deviceMapper.selectCameraDepartmentByCode(code);
        if(department != null){
            List<DepartmentDeviceForUseType> deviceForUseTypes = deviceMapper.selectCameraDepartmentById(department.getId());
            for(DepartmentDeviceForUseType deviceForUseType : deviceForUseTypes){
                if(null == deviceForUseType.getUseType()){
                    continue;
                }
                deviceForType.add(deviceForUseType);
            }
        }
        return deviceForType;
    }

    /**
     * @param id
     * @return 服务端获取设备类型
     */
    @Override
    public List<DepartmentDeviceForUseType> selectCameraDepartmentById(Integer id) {
        List<DepartmentDeviceForUseType> deviceForType = new ArrayList<>();
        List<DepartmentDeviceForUseType> deviceForUseTypes = deviceMapper.selectCameraDepartmentById(id);
        for(DepartmentDeviceForUseType deviceForUseType : deviceForUseTypes){
            if(null == deviceForUseType.getUseType()){
                continue;
            }
            deviceForType.add(deviceForUseType);
        }
        return deviceForType;
    }

    /**
     * @param departmentId
     * @param departmentDeviceForUseType
     * @return  更新摄像头的用途类型
     */
    @Override
    public ResponseModel updateDeviceUseType(Integer departmentId,List<DepartmentDeviceForUseType> departmentDeviceForUseType) {
        int result = 0;
        if(null != departmentDeviceForUseType && departmentDeviceForUseType.size() > 0){
            result =  deviceMapper.updateDeviceUseType(departmentDeviceForUseType);
        }
       return ResponseModel.ok(result);
    }

    /**
     * @param deviceId
     * @return 删除摄像头
     */
    @Override
    public ResponseModel deleteDeviceForCamera(Integer deviceId) {
        int i = deviceMapper.deleteByDeviceId(deviceId);
        return ResponseModel.ok(i);
    }

    /**
     * @param departmentId
     * @param cameraCoordinates
     * @return 上传门店摄像头部署坐标箭头指示
     */
    @Override
    public ResponseModel uploadDeviceForCameraCoordinates(Integer departmentId, CameraCoordinatesTwo cameraCoordinates,Integer deviceId) {
        ResponseModel responseModel = new ResponseModel();
        // 1.摄像头显示箭头的数据
        JSONObject jsonAll = new JSONObject();

        // 2.获取门店最新部署文件
        List<HardwareDeploymentFile> deploymentFile = deviceMapper.getDeploymentFile(departmentId);
        long randomNum = System.currentTimeMillis();
        if(null != deploymentFile && deploymentFile.size() > 0){
            String urlFile = deploymentFile.get(0).getDeploymentFilePath();
            String urlFileName = deploymentFile.get(0).getDeploymentFileName();
            String[] split = urlFileName.split("\\.");
            urlFileName = split[0];
            if(StringUtils.isNotBlank(urlFile)){
                // 3.下载并解压
                byte[] imageFromURL = CompressionFile.getImageFromURL(urlFile);
                File file = CompressionFile.getFileByBytes(imageFromURL, CommonParams.INSTALL_DEPLOYMENT_FILE_COMPRESSIONFILE, randomNum+CommonParams.INSTALL_DEPLOYMENT_FILE_TEST);
                // 4.解析并追加
                if(null != file) {
                    try {
                        if (!file.exists()) {
                            file.createNewFile();
                        }
                        FileVo fileVo = CompressionFile.UnZipFolder(file.getAbsolutePath(), CommonParams.INSTALL_DEPLOYMENT_FILE_COMPRESSIONFILE + urlFileName + File.separator);
                        if (null != fileVo) {
                            logger.info("add  before  ...  media.json is {}", fileVo.getWrite());
                            HashMap<String, Object> hashMap2 = JSONObject.parseObject(fileVo.getWrite(), HashMap.class);

                            // 写入摄像头画图线数据
                            if(null != hashMap2.get(deviceId.toString())){
                                logger.info("Write the configuration file for the first time , deviceId is {} ", deviceId);
                                HashMap<String, Object> oldValue = JSONObject.parseObject(hashMap2.get(deviceId.toString()).toString(), HashMap.class);
                                // 加入线的方向
                                setLineDirection(cameraCoordinates.getLineList());
                                oldValue.put("lineList",cameraCoordinates.getLineList());
                                hashMap2.put(deviceId.toString(),oldValue);
                            }
                            jsonAll.putAll(hashMap2);
                            logger.info("add after ... media.json is {}", jsonAll);
                            FileWriter fileWriter = new FileWriter(fileVo.getFile().getParent() + CommonParams.INSTALL_DEPLOYMENT_FILE_MEDIA, false);
                            fileWriter.write(jsonAll.toJSONString());
                            fileWriter.flush();
                            fileWriter.close();
                            // 5. 重新压缩
                            File fileResult = CompressionFile.ZipFolder(fileVo.getFile().getParent(), fileVo.getFile().getParent() + CommonParams.FILE_TYPE_ZIP);
                            // 6. 更新上传
                            if(fileResult.exists()){
                                logger.info("file exist !!!!!! file path is {} " ,fileResult.getPath());
                                String path = fileResult.getPath() + CommonParams.FILE_TYPE_ZIP;
                                File file1 = new File(path);
                                FileInputStream fileInputStream = new FileInputStream(file1);
                                MultipartFile multipartFile = new MockMultipartFile(file1.getName(), file1.getName(),
                                        ContentType.APPLICATION_OCTET_STREAM.toString(), fileInputStream);
                                fileInputStream.close();
                                responseModel = resourceServiceImpl.updateHardwareConfigFile(departmentId,multipartFile,"install");
                            }
                        }
                        // 删除下载压缩包
                        System.gc();
                        CompressionFile.delFolder(CommonParams.INSTALL_DEPLOYMENT_FILE_COMPRESSIONFILE);
                    } catch (Exception e) {
                        logger.info(" have an exception , Failed to parse the uploaded file");
                    }
                }
            }
        }

        return responseModel;
    }

    /**
     * @param lineList
     * @return 设置路过进店线左右
     */
    public void setLineDirection(List<CameraCoordinates> lineList){

        List<CameraCoordinates> lineListNew = new ArrayList<>();
        for(CameraCoordinates cameraCoordinates : lineList){
            if(cameraCoordinates.getLineType()== 0){
                cameraCoordinates.setDirection(CommonParams.LINE_TYPE_DIRECTION_ENTER);
            }else{
                lineListNew.add(cameraCoordinates);
            }
        }
        // 路过线设置左右
        if(lineListNew.size() > 1){
            lineListNew.sort(Comparator.comparing(CameraCoordinates::getStartX).thenComparing(CameraCoordinates::getEndX));
            lineListNew.get(0).setDirection(CommonParams.LINE_TYPE_DIRECTION_LEFT);
            lineListNew.get(1).setDirection(CommonParams.LINE_TYPE_DIRECTION_RIGHT);
        }else{
            lineListNew.get(0).setDirection(CommonParams.LINE_TYPE_DIRECTION_LEFT);
        }
    }
    public List<DepartmentDeviceForBtit> getAllDeviceListForPage(Integer tenant,String shopCode, String status, String type) {
        List<DepartmentDeviceForBtit> allDeviceListForPage = deviceMapper.getAllDeviceListForPage(tenant, shopCode, status, type);
        Integer departmentId = null;
        String edgeServerIP = "";
        if(null != allDeviceListForPage && allDeviceListForPage.size() > 0){
            for(DepartmentDeviceForBtit departmentDevice : allDeviceListForPage){
                String jsonConfig = departmentDevice.getJsonConfig();
                if(null != jsonConfig && !"".equals(jsonConfig)){
                    HashMap<String,String> hashMap = JSONObject.parseObject(jsonConfig, HashMap.class);
                    departmentDevice.setIp(hashMap.get("ip"));
                }
               // 查找edgeServer ip
                if(type.equals("end")){
                    departmentId = departmentDevice.getdId();
                    DepartmentDevice edgeServer = deviceMapper.selectEdgeServerByDepartmentId(departmentId,departmentDevice.getId());
                    if(null != edgeServer){
                        String edgeJsonConfig = edgeServer.getJsonConfig();
                        if(null != edgeJsonConfig && !"".equals(edgeJsonConfig)){
                            HashMap<String,String> hashMap = JSONObject.parseObject(edgeJsonConfig, HashMap.class);
                            edgeServerIP = hashMap.get("ip");
                        }
                        departmentDevice.setEdgeServerId(edgeServer.getId());
                        departmentDevice.setEdgeServerCode(edgeServer.getServerCode());
                    }
                    departmentDevice.setEdgeServerIP(edgeServerIP);
                }
            }
        }
        return allDeviceListForPage;
    }

    @Override
	//@Cacheable(cacheNames = "department", key = "#dcode")
	public Department selectDepartmentByCode(String dcode) {
		Department department = departmentMapper.selectByDcode(dcode);
		if (department != null) {
            department.setDepartmentDeviceList(selectDepartmentDeviceBydepartmentId(department.getId()));
			department.setDepartmentDeviceTopologys(selectDepartmentDeviceTopologyById(department.getId()));
		}

		return department;
	}

	@Override
	//@Cacheable(cacheNames = "allDepartment")
	public List<Department> selectAllDepartment(String name, String dCode) {
        List<Department> departments = departmentMapper.selectAll(name, dCode);
        if(null != departments && departments.size() > 0){
            for(Department department : departments){
                List<DepartmentDevice> departmentDevices = selectDepartmentDeviceBydepartmentId(department.getId());
                department.setDepartmentDeviceList(departmentDevices);
               // department.setDepartmentDeviceTopologyList(selectAllDepartmentTopologyByDepartmentId(department.getId()));
                // 门店是否配置配置单/完成拓扑图构建
                setDepartmentIsConfig(department,departmentDevices);
            }
        }
		return departments;
	}

    /**
     * @param department
     * @param departmentDevices
     * @return 门店是否配置配置单/完成拓扑图构建
     */
	public Department setDepartmentIsConfig(Department department, List<DepartmentDevice> departmentDevices){
        //是否配置过设备
        List<Integer> eIds = new ArrayList<>();
        List<Integer> tIds = new ArrayList<>();
        department.setIsConfig(0);
        // 是否完成构建拓扑图
        department.setIsCompleteTopology(0);
        if(null != departmentDevices && departmentDevices.size() > 0){
            department.setIsConfig(1);
            for(DepartmentDevice departmentDevice :departmentDevices){
                eIds.add(departmentDevice.getId());
            }
            List<DepartmentDeviceTopology> departmentDeviceTopologys = topologyMapper.selectTopologyBydId(department.getId());
           if(null != departmentDeviceTopologys && departmentDeviceTopologys.size() > 0){
               for(DepartmentDeviceTopology deviceTopology :departmentDeviceTopologys){
                   tIds.add(deviceTopology.getFromDeviceId());
                   tIds.add(deviceTopology.getToDeviceId());
               }
               if(tIds.size() > 0 && null != tIds && tIds.size() > eIds.size() && departmentDeviceTopologys.size() >= eIds.size()){
                   List<Integer> integers = diffList(eIds, tIds);
                   if(tIds.contains(-1) && integers.size() >= 1){
                       department.setIsCompleteTopology(1);
                   }
               }
           }
        }
        return department;
    }

	@Override
	//@CachePut(cacheNames = "department", key = "#record.id")
	public int updateDepartmentById(Department record) {
		return departmentMapper.updateByPrimaryKey(record);
	}

	@Override
	/*@Caching(evict = { @CacheEvict(cacheNames = "departmentDevice", key = "#id"),
			@CacheEvict(cacheNames = "allDepartmentDevice", allEntries = true) })*/
	public int deleteDepartmentDevice(Integer id) {
		return deviceMapper.deleteByPrimaryKey(id);
	}

	@Override
	//@CacheEvict(cacheNames = "allDepartmentDevice", allEntries = true)
	@Transactional(rollbackFor = Exception.class)
	public int insertDepartmentDevice(List<AddDepartmentDevice> record, Integer dId, String type) {
        int insert = 0 ;
        List<DepartmentDevice> addList = new ArrayList<>();
        List<Integer> newEids = new ArrayList<>();
        List<Integer> addEids = new ArrayList<>();
        List<Integer> intRecord = new ArrayList<>();
        List<Integer> integers = new ArrayList<>();
        List<Integer> oldIds = new ArrayList<>();
        List<Integer> ids = new ArrayList<>();
        List<Integer> idsList = new ArrayList<>();
        if(null != record && record.size() > 0){
            // 1.0 id 为空 新配置单
            for(AddDepartmentDevice addDepartmentDevice : record){
                if(null == addDepartmentDevice.getId() || "".equals(addDepartmentDevice.getId())){
                    addEids.add(addDepartmentDevice.geteId());
                }else{
                    newEids.add(addDepartmentDevice.geteId());
                    ids.add(addDepartmentDevice.getId());
                }
            }
        	//  区别从拓扑图还是店铺添加配置单
            if(CommonParams.ADD_EDGE_DEVICE_TYPE.equals(type)){
                // 1.1查询原来的配置单
                List<DepartmentDevice> deviceList = deviceMapper.selectByDepartmentId(dId);

                //1.2 做对比（多出来的删除）
                if(null != deviceList && deviceList.size() > 0){
                    for(DepartmentDevice departmentDevice : deviceList){
                        intRecord.add(departmentDevice.geteId());
                        oldIds.add(departmentDevice.getId());
                    }
                    //1.3 新list 和旧list 做对比 那个size大循环哪个<删除多余配置单>
                    if(intRecord.size() > newEids.size()){
                        integers = diffList(newEids, intRecord);
                    }else{
                        integers = diffList(intRecord,newEids);
                    }
                    // 1.3.2 若相同配置单 则看id
                    if(newEids.size() != intRecord.size() && integers.size() == 0){
                        idsList = diffList(ids,oldIds);
                    }
                    if(null != integers && integers.size() > 0){
                        deviceMapper.deleteByPrimaryKeys(integers,dId);
                    }
                    if(null != idsList && idsList.size() > 0){
                        deviceMapper.deleteByIds(idsList);
                    }
                }
        	}
            // 2. 重新新增配置单
            List<EdgeDevice> edgeDeviceList = new ArrayList<>();
            if(null != addEids && addEids.size() > 0){
                for(Integer eId : addEids){
                    EdgeDevice edgeDevice = edgeDeviceMapper.selectByPrimaryKey(eId);
                    edgeDeviceList.add(edgeDevice);
                }
                //	List<EdgeDevice> edgeDeviceList = edgeDeviceMapper.selectAllByPrimaryKey(edges);
                List<DepartmentDevice> departmentDevices = deviceMapper.selectBydId(dId);
                if(null != edgeDeviceList && edgeDeviceList.size() > 0){
                    int index = 0;
                    for (EdgeDevice edgeDevice : edgeDeviceList) {
                        int serverId = 0;
                     //   serverId = (null != departmentDevices && departmentDevices.size() > 0) ? edgeDevice.getTypeId() + departmentDevices.size():edgeDevice.getTypeId();
                        DepartmentDevice newRecord = new DepartmentDevice();
                        newRecord.setdId(dId);
                        newRecord.seteId(edgeDevice.getId());
                        newRecord.setConfigName(edgeDevice.getName());
                       // int num = theSameNumber(addList,newRecord);
                        // serverId = num > 0 ? num + serverId : serverId;
                        serverId = departmentDevices.size() > 0 ? departmentDevices.size() + 1 + index : index + 1;

                        newRecord.setServerName(serverId + "_" + edgeDevice.getName());
                        newRecord.insertGenerator();
                        // 设备状态： 默认未激活
                        newRecord.setStatus(2);
                        addList.add(newRecord);
                        index++;
                    }
                }
                insert = deviceMapper.insertList(addList);
                departmentMapper.updateDepertment(dId);
            }
        }else{
            insert =  deviceMapper.deleteByPrimaryKey(dId);
        }
		return insert;
	}

	public int theSameNumber(List<DepartmentDevice> addList, DepartmentDevice newRecord){
        Map<Integer,Integer> map = new HashMap<>();
        for (DepartmentDevice i : addList) {
            if(map.containsKey(i.geteId())) {
                map.put(i.geteId(), map.get(i.geteId()).intValue()+1);
            }else {
                map.put(i.geteId(), new Integer(1));
            }
        }
        Iterator<Integer> iter = map.keySet().iterator();
        while(iter.hasNext()) {
            Integer key = iter.next();
            if(key.equals(newRecord.geteId())){
                return map.get(key);
            }
            //map.get(key) 数量
        }
        return 0;
    }
    /**
     * @param i small
     * @param j big
     * @return different
     */
    public List<Integer> diffList(List<Integer> i, List<Integer> j){
        List<Integer> newInteger = new ArrayList<>();
        for (int k = 0; k < j.size() ; k++) {
            if(i.contains(j.get(k))){
                continue;
            }else{
                newInteger.add(j.get(k));
            }
        }
        return newInteger;
    }
	@Override
	//@Cacheable(cacheNames = "departmentDevice", key = "#id")
	public DepartmentDevice selectDepartmentDeviceById(Integer id) {
		DepartmentDevice departmentDevice = deviceMapper.selectByPrimaryKey(id);
		if (departmentDevice != null) {
			departmentDevice.setEdgeDevice(edgeDeviceService.selectEdgeDeviceById(departmentDevice.getdId()));
		}
		return departmentDevice;
	}

	@Override
	//@Cacheable(cacheNames = "allDepartmentDevice", key = "#departmentId")
	public List<DepartmentDevice> selectDepartmentDeviceBydepartmentId(Integer departmentId) {
		List<DepartmentDevice> list = deviceMapper.getDepartmentEdgeDevicedetail(departmentId);
		List<Integer> eIds = new ArrayList<>();
		List<Integer> topoIds = new ArrayList<>();
		if(null != list && list.size() > 0){
			for (DepartmentDevice departmentDevice : list) {
				eIds.add(departmentDevice.geteId());
            }
			List<EdgeDevice> edgeDeviceList = edgeDeviceService.selectAllEdgeDeviceById(eIds);
            // 是否被拖拽
            List<DepartmentDeviceTopology> deviceTopology = topologyMapper.selectDepartmentDeviceTopology(departmentId);
            if(null != deviceTopology && deviceTopology.size() > 0){
                String data = deviceTopology.get(0).getData();
                DepartmentDeviceTopologyParam departmentDeviceTopologyParam = JSON.parseObject(data, DepartmentDeviceTopologyParam.class);
                List<NodeData> nodeDataArray = departmentDeviceTopologyParam.getNodeDataArray();
                for(NodeData nodeData : nodeDataArray){
                    if(nodeData.getType().equals(CommonParams.DEPARTMENT)){
                        continue;
                    }else{
                        topoIds.add(nodeData.getId());
                    }
                }
            }

			if(null != edgeDeviceList && edgeDeviceList.size() > 0){
				for (DepartmentDevice departmentDevice : list) {
				    List<String> params = new ArrayList<>();
                    // 重新组装
                    HashMap<String, List<String>> allParam = new HashMap<>();
					for(EdgeDevice edgeDevice : edgeDeviceList){
						if(departmentDevice.geteId().equals(edgeDevice.getId())){
						    // 拼接设备的所有配置参数
                            allParam.putAll(edgeDevice.getAllParam());  // 软件硬件的参数
                            departmentDevice.setEdgeDevice(edgeDevice);
						}
					}
					params.add(departmentDevice.getJsonConfig());
                    allParam.put(CommonParams.DEPARTMENT_DEVICE ,params); // 设备额外添加的参数
                    departmentDevice.setAllParam(allParam);
                    departmentDevice.setIsDrag(0);
                    if(null != topoIds && topoIds.size() > 0){
                        for (int i = 0; i < topoIds.size(); i++) {
                            if(topoIds.get(i).equals(departmentDevice.getId())){
                                departmentDevice.setIsDrag(1);
                            }
                        }
                    }
				}
			}
		}
		return list;
	}

	@Override
	//@Cacheable(cacheNames = "allDepartmentDevice")
	public List<DepartmentDevice> selectAllDepartmentDevice() {
		List<DepartmentDevice> list = deviceMapper.selectAll();
		for (DepartmentDevice departmentDevice : list) {
			departmentDevice.setEdgeDevice(edgeDeviceService.selectEdgeDeviceById(departmentDevice.getdId()));
		}
		return list;
	}

	@Override
	//@CachePut(cacheNames = "departmentDevice", key = "#record.id")
	public int updateDepartmentDeviceById(DepartmentDevice record) {
        return deviceMapper.updateByPrimaryKey(record);
	}

	@Override
	/*@Caching(evict = { @CacheEvict(cacheNames = "DeviceTopology", key = "#id"),
			@CacheEvict(cacheNames = "allDeviceTopology", allEntries = true) })*/
	public int deleteDepartmentDeviceTopologyById(Integer id) {
		return topologyMapper.deleteByPrimaryKey(id);
	}

	/**
	 * @about save DepartmentDeviceTopology
	 * @param record
	 * @return
	 */
	@Override
	//@CacheEvict(cacheNames = "allDeviceTopology", allEntries = true)
	@Transactional(rollbackFor = Exception.class)
	public ResponseModel insertDepartmentDeviceTopology(DepartmentDeviceTopology record) {
        int insert = 0;
       //1.转换json字符串为对象
        DepartmentDeviceTopologyParam departmentDeviceTopologyParam = JSON.parseObject(record.getJsonParam(), DepartmentDeviceTopologyParam.class);
        record.setData(record.getJsonParam());
        // 2.判断是新增还是修改
        List<DepartmentDeviceTopology> topology = topologyMapper.selectByPrimaryKey(record.getdId());
        if(null != topology && topology.size() > 0){
            topologyMapper.deleteByPrimaryKey(record.getdId());
        }
        // 3.保存关系
        List<NodeData> nodeDataArray = departmentDeviceTopologyParam.getNodeDataArray();
        List<LinkData> linkDataArray = departmentDeviceTopologyParam.getLinkDataArray();
		List<DepartmentDeviceTopology> newRecordList = new ArrayList<>();
		List<DepartmentDevice> newDepartmentDeviceList = new ArrayList<>();

        if(null != linkDataArray && linkDataArray.size() > 0){
            for (LinkData linkData : linkDataArray){
				DepartmentDeviceTopology newRecord = new DepartmentDeviceTopology();
				newRecord.setFromDeviceId(linkData.getFrom());
				newRecord.setToDeviceId(linkData.getTo());
				newRecord.setdId(record.getdId());
				newRecord.setData(record.getData());
				newRecordList.add(newRecord);
            }
        }else{
            DepartmentDeviceTopology newRecord = new DepartmentDeviceTopology();
            newRecord.setdId(record.getdId());
            newRecord.setData(record.getData());
            newRecordList.add(newRecord);
        }

        List<CameraCoordinates> cameraLineList = new ArrayList<>();
        List<Integer> cameraForHeatingPower = new ArrayList<>();
        List<ControlServerCamList> camLists = new ArrayList<>();
        List<ControlServerCamera> controlServerHeartCameras = new ArrayList<>();
        // 进店摄像头  id:视频流地址
        HashMap<String, Object> inStoreDevice = new HashMap<>();
        Integer eId = 0; // tx2的id

        if(null != nodeDataArray && nodeDataArray.size() > 0){
            for (NodeData nodeData : nodeDataArray){
                // 4. 修改设备详情
                if(!CommonParams.DEPARTMENT.equals(nodeData.getType())){
                    DepartmentDevice device =new DepartmentDevice();
                    device.setId(nodeData.getId());
                    device.setServerName(nodeData.getName());
                    device.setParam(nodeData.getParameter());
                    device.setDescription(nodeData.getDescription());
                    device.setJsonConfig(nodeData.getJsonConfig());
                  //  device.setUseType(nodeData.getUseType());
					newDepartmentDeviceList.add(device);
                }
                // 5.1 组装数据
               // addData(eId, nodeData, cameraLineList, inStoreDevice, cameraForHeatingPower, camLists, controlServerHeartCameras);
            }

            /* // 5.2 向controlServer发送配置信息
            ResponseModel responseModel = sendControlServerConfig(record, cameraForHeatingPower, eId, camLists, cameraLineList, inStoreDevice, controlServerHeartCameras);
            if(responseModel.getStatus() != 0){
                logger.info("controlServer update config is defeated , message is {} page is 870" ,responseModel.getMessage());
                return responseModel;
            }
            // 6.更新部署文件
            CameraCoordinatesTwo cameraCoordinates = new CameraCoordinatesTwo();
            cameraCoordinates.setLineList(cameraLineList);
            Object inStoreDeviceId = inStoreDevice.get("inStoreDeviceId");
            ResponseModel model = uploadDeviceForCameraCoordinates(record.getdId(), cameraCoordinates, (Integer) inStoreDeviceId);
            if(model.getStatus() != 0){
                logger.info("update cameraConfig is defeated , message is {} page is 879" ,model.getMessage());
                return model;
            }*/
            // 7. 更改属性
            if(null != newDepartmentDeviceList && newDepartmentDeviceList.size() > 0){
				deviceMapper.updateListByPrimaryKey(newDepartmentDeviceList);
				departmentMapper.updateDepertment(record.getdId());
			}
        }
        // 8. 更改topo图
        if(newRecordList.size() > 0){
            insert = topologyMapper.insertDepartmentDeviceTopologyList(newRecordList);
        }
        Set<Integer> fromIds = new HashSet<>();
        // 9. 记录门店使用的模型包
        for(DepartmentDeviceTopology departmentDeviceTopology :newRecordList){
            if(departmentDeviceTopology.getFromDeviceId() > 0){
                if(!fromIds.contains(departmentDeviceTopology.getFromDeviceId())){
                    fromIds.add(departmentDeviceTopology.getFromDeviceId());
                }
            }
            if(departmentDeviceTopology.getFromDeviceId() == -1){
                if(!fromIds.contains(departmentDeviceTopology.getToDeviceId())){
                    fromIds.add(departmentDeviceTopology.getToDeviceId());
                }
            }
        }

        HashMap<String, Object> hashMap = new HashMap<>();
        List<SoftwareConfig> softwareConfigs = new ArrayList<>();
        // 查找使用的模型包
        List<Software> softwareList = softwareMapper.selectEdgeServerDetail(record.getdId(),null);

        for(Software software :softwareList){
            for(Integer id :fromIds){
                if(software.getEdgeServerId().equals(id)){
                    SoftwareConfig softwareConfig = new SoftwareConfig();
                    String stopScript = "#!/bin/bash\n" +
                            "\n" +
                            "pid=`ps -ef |grep %s |grep -v 'grep'| awk '{ print $2 }'`;\n" +
                            "\n" +
                            "if [  -n  \"$pid\"  ];  then\n" +
                            "   echo pid=$pid\n" +
                            "   kill  -9  $pid;\n" +
                            "fi";
                    softwareConfig.setStopScript(stopScript);
                    softwareConfig.setdId(record.getdId());
                    softwareConfig.setEdgeDeviceId(software.getEdgeServerId());
                    softwareConfig.setsName(software.getFileName());
                    softwareConfig.setsId(software.getId());
                    softwareConfig.setVersion(software.getVersion());
                    softwareConfig.setsUrl(software.getFilePath());
                    softwareConfig.setCode(UUID.randomUUID().toString().substring(0,8).replace("-","a").trim());
                    softwareConfigs.add(softwareConfig);
                }
            }
        }
        // 判断是否存在，存在不需要重复添加
        for (int i = 0; i < softwareConfigs.size(); i++){
            List<SoftwareConfig> configs = softwareMapper.selectSoftwareConfigBysId(softwareConfigs.get(i).getdId(), softwareConfigs.get(i).getEdgeDeviceId(),softwareConfigs.get(i).getsId());
            if(null != configs && configs.size() > 0){
                softwareConfigs.remove(softwareConfigs.get(i));
                i=i-1;
            }
        }

        if(softwareConfigs.size() > 0 && null != softwareConfigs){
            softwareMapper.insertSoftWareConfig(softwareConfigs);
        }
        record.setId(insert);
        return ResponseModel.ok(record);
	}

    /**
     * @param eId
     * @param nodeData
     * @param cameraLineList
     * @param inStoreDevice
     * @param cameraForHeatingPower
     * @param camLists
     * @param controlServerHeartCameras
     * @param
     */
	public void addData(Integer eId, NodeData nodeData, List<CameraCoordinates> cameraLineList, HashMap<String, Object> inStoreDevice,
                        List<Integer> cameraForHeatingPower, List<ControlServerCamList> camLists, List<ControlServerCamera> controlServerHeartCameras){
        if(StringUtils.isEmpty(nodeData.getUseType())){
            eId = nodeData.getId();
        }else{
            // 1.进店摄像头的进店画线数据 目前只有一台
            if(CommonParams.CAMERA_USE_TYPE_1.equals(nodeData.getUseType())){
                cameraLineList = nodeData.getCameraLineList();
                inStoreDevice.put("inStoreDeviceId", nodeData.getId());
                inStoreDevice.put("inStoreDeviceRtspurl", nodeData.getRtspurl());
            }
            if(CommonParams.CAMERA_USE_TYPE_2.equals(nodeData.getUseType())){
                cameraForHeatingPower.add(nodeData.getId());
            }
            //2.视频流地址  <id: 地址>
            ControlServerCamList serverCamList = new ControlServerCamList();
            serverCamList.setId(nodeData.getId());
            serverCamList.setUri(nodeData.getRtspurl());
            camLists.add(serverCamList);
            //3.心跳  <code: 地址>
            ControlServerCamera camera = new ControlServerCamera();
            camera.setCode(nodeData.getCode());
            camera.setHost(nodeData.getRtspurl());
            controlServerHeartCameras.add(camera);
        }
    }
    /**
     * @param record
     * @param eId
     * @return  向controlServer发送配置信息
     */
/*	public ResponseModel sendControlServerConfig(DepartmentDeviceTopology record ,List<Integer> cameraForHeatingPower ,
                                                 Integer eId, List<ControlServerCamList> camLists, List<CameraCoordinates>  cameraLineList,
                                                 HashMap<String, Object>  inStoreDevice, List<ControlServerCamera> controlServerHeartCameras){*/
    public ResponseModel sendControlServerConfig(DepartmentDeviceTopology record , Integer eId){
        // 组装单个模型的数据
    /*    ResponseModel responseModel = edgeServiceImpl.selectDeviceByTx2IdAndDepartmentId(record.getdId(), eId);
        HashMap<String,Object> deepstreamHashmap = (HashMap<String, Object>) responseModel.getResult();
       *//* StringBuffer stringBuffer = new StringBuffer();
        ResponseModel responseModel = new ResponseModel();
        if(cameraForHeatingPower.size() > 0 && null != cameraForHeatingPower){
            // 1.ds-example
            HashMap<String, Object> deepHashmap = new HashMap<>();
            HashMap<String, Object> hashmap = new HashMap<>();
            HashMap<String, Object> dsExampleHashmap = new HashMap<>();
            HashMap<String, Object> camListHashmap = new HashMap<>();
            HashMap<String, Object> smartStoreAddHashmap = new HashMap<>();
            HashMap<String, Object> enterJudgmentHashmap = new HashMap<>();
            HashMap<String, Object> sendHashmap = new HashMap<>();
            HashMap<String, Object> sendAddHashmap = new HashMap<>();
            HashMap<String, Object> tx2HeartHashmap = new HashMap<>();
            HashMap<String, Object> tx2AddHashmap = new HashMap<>();
            HashMap<String, Object> deepstreamHashmap = new HashMap<>();

            Department department = departmentMapper.selectByPrimaryKey(record.getdId());

            dsExampleHashmap.put("sid",department.getBtitdCode());
            dsExampleHashmap.put("cid",eId);
            for(Integer i : cameraForHeatingPower){
                stringBuffer.append( i + ";");
            }
            String substring = stringBuffer.toString().substring(0, stringBuffer.length() - 1);
            dsExampleHashmap.put("index",substring);
            hashmap.put("ds-example",dsExampleHashmap);

            // 2.camList
            camListHashmap.put("camList",camLists);
            deepHashmap.putAll(hashmap);
            deepHashmap.putAll(camListHashmap);
            // 3.smartstore   进店摄像头的画线数据
            ControlServerCameraLineList cameraLineList1 = new ControlServerCameraLineList();
            if(cameraLineList.size() > 0 && null != cameraLineList){
                CameraCoordinates cameraCoordinates = cameraLineList.get(0);
                int[] lineStart = {(int)cameraCoordinates.getStartX(),(int)cameraCoordinates.getStartY()};
                int[] lineEnd = {(int)cameraCoordinates.getEndX(),(int)cameraCoordinates.getEndY()};
                int[] directionStart = {(int)cameraCoordinates.getArrowsStartX(),(int)cameraCoordinates.getArrowsStartY()};
                int[] directionEnd = {(int)cameraCoordinates.getArrowsEndX(),(int)cameraCoordinates.getArrowsEndY()};
                cameraLineList1.setLineStart(lineStart);
                cameraLineList1.setLineEnd(lineEnd);
                cameraLineList1.setDirectionEnd(directionStart);
                cameraLineList1.setDirectionStart(directionEnd);
            }
            enterJudgmentHashmap.put("ENTER_JUDGMENT",cameraLineList1);

            // 进店摄像头的数据 - 视频流地址
            sendAddHashmap.put("video_source",inStoreDevice.get("inStoreDeviceRtspurl"));
            sendAddHashmap.put("sid",department.getBtitdCode());
            sendAddHashmap.put("eid",eId);
            sendAddHashmap.put("cid",inStoreDevice.get("inStoreDeviceId"));
            sendHashmap.put("SEND",sendAddHashmap);
            smartStoreAddHashmap.putAll(enterJudgmentHashmap);
            smartStoreAddHashmap.putAll(sendHashmap);

            // 4.tx2 配置
            tx2HeartHashmap.put("camera",controlServerHeartCameras);
            tx2AddHashmap.putAll(tx2HeartHashmap);

            // 5.组装
            deepstreamHashmap.put("deepstream",deepHashmap);
            deepstreamHashmap.put("smartstore",smartStoreAddHashmap);
            deepstreamHashmap.put("tx2",tx2AddHashmap);*//*
            // 1. 修改全局配置
            responseModel = restTemplate.postForObject(CONTROL_SERVER_INIT + "aimigos/v1/project/"+ record.getdId() +"/device/"+ eId +"/model/changeConfig", deepstreamHashmap, ResponseModel.class);
            if(responseModel.getStatus() != 0){
                logger.error("controlServer not first run error ,message is {}", responseModel.getMessage());
                return responseModel;
            }else{
                // 延迟查询
                logger.info("延时前:"+ new Date().toString());
                try {
                    Thread.sleep(3000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                logger.info("延时后:"+ new Date().toString());
                HashMap hashMap = (HashMap)responseModel.getResult();
                ResponseModel responseModelResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "aimigos/v1/result", hashMap, ResponseModel.class);
                logger.info("seccessful request update config , select ststus is {} result is {} " + responseModelResult.getStatus() + responseModelResult.getResult());
                int length = getLength(responseModelResult.getResult());
                if(length < 2){
                    return ResponseModel.fail(CommonParams.SELECT_RESULT_FAIL,1);
                }
            }
        // 2. 重启tx2关联所有模型
        List<SoftwareConfig> softwareConfigs = softwareMapper.selectSoftwareConfig(record.getdId(), eId);

        for(SoftwareConfig so : softwareConfigs){
            EdgeServerInitVo edgeServerInitvO = new EdgeServerInitVo();
            edgeServerInitvO.setSoftwareCode(so.getsCode());
            edgeServerInitvO.setModelCode(so.getCode());
            run(record.getdId(), eId, edgeServerInitvO);
        }*/
           /* reStartToContrlServer("smartstore", record.getdId(), eId);
            reStartToContrlServer("deepstream", record.getdId(), eId);*/
        //}

        return ResponseModel.ok(0);
    }
	@Override
//	@Cacheable(cacheNames = "allDeviceTopology", key = "#id")
	public DepartmentDeviceTopology selectDepartmentDeviceTopologyById(Integer id) {
       // DepartmentDeviceTopologyParamVo result = new DepartmentDeviceTopologyParamVo();
        // 回显拓扑图
        DepartmentDeviceTopology departmentDeviceTopologies = topologyMapper.selectTopologyByDepartmentId(id);

     /*  List<LinkData> linkData = new ArrayList<>();
         if(null != departmentDeviceTopologies && departmentDeviceTopologies.size() > 0){
			for(DepartmentDeviceTopology param: departmentDeviceTopologies){
				LinkData data =new LinkData();
				data.setFrom(param.getFromDeviceId());
				data.setFromPort("output");
				data.setTo(param.getToDeviceId());
				data.setToPort("input");
				linkData.add(data);
			}
		}*/
      /*  result.setLinkDataArray(linkData);
        List<NodeDataVo> nodeDataList = new ArrayList<>();
        List<NodeData> departmentDeviceTopologyParam = topologyMapper.selectAllTopology(id);
        if(null != departmentDeviceTopologyParam && departmentDeviceTopologyParam.size() > 0){
			for(NodeData  nodeData: departmentDeviceTopologyParam){
				result.setLinkFromPortIdProperty(nodeData.getLinkFromPortIdProperty());
				result.setLinkToPortIdProperty(nodeData.getLinkToPortIdProperty());
                NodeDataVo nodeDataVo = new NodeDataVo();
                nodeDataVo.setId(Integer.parseInt(nodeData.getnId()));
                nodeDataVo.setCode(nodeData.getCode());
                nodeDataVo.setSource(nodeData.getName());
                nodeDataVo.setKey(nodeData.getKye());
                nodeDataVo.setCategory(nodeData.getCategory());
                nodeDataVo.setLoc(nodeData.getLoc());
                nodeDataVo.setdId(nodeData.getdId());
                nodeDataVo.setTextimg(nodeData.getTextimg());
                nodeDataVo.setIdx(nodeData.getIdx());
                nodeDataVo.setName(nodeData.getName());
                nodeDataVo.setType(nodeData.getType());
				// 携带参数返回
				if(!"department".equals(nodeData.getType())){
                    DepartmentDevice device = deviceMapper.selectByPrimaryKey(nodeData.getId());
                    if(null != device){
                        nodeDataVo.setParameter(device.getParam());
                        nodeDataVo.setDescription(device.getDescription());
                    }
                }
				nodeDataList.add(nodeDataVo);
			}
		}
        result.setNodeDataArray(nodeDataList);*/

        return departmentDeviceTopologies;

	}

	@Override
	//@Cacheable(cacheNames = "allDeviceTopology")
	public List<Department> selectAllDepartmentTopology() {
        List<Department> departmentList = selectAllDepartment(null, null);
        return departmentList;
	}

	@Override
	//@Cacheable(cacheNames = "allDeviceTopology",key="#departmentId")
	public List<DepartmentDeviceTopology> selectAllDepartmentTopologyByDepartmentId(Integer departmentId) {
		return null;
	}

	@Override
	//@CachePut(cacheNames="DeviceTopology",key = "#record.id")
	public int updateDepartmentDeviceTopologyById(DepartmentDeviceTopology record) {
		return topologyMapper.updateByPrimaryKey(record);
	}

    /**
     * @about select department address
     * @return
     */
    @Override
    public ResponseModel getDepartmentAddress() {
        List<City> city = departmentMapper.getDepartmentAddress();
        List<TreeType> nodes = Lists.newArrayList();

        for (int i = 0; i < city.size(); i++) {
            nodes.add(new TreeType(city.get(i).getId(), city.get(i).getName(), city.get(i).getName(), city.get(i).getpId()));
        }
        return ResponseModel.ok(TreeConfig.getTree(nodes));
    }

    /**
     * @about department edgeDevice detail
     * @param id
     * @return
     */
    @Override
   // @Cacheable(cacheNames = "DepartmentDevice", key = "#id")
    public List<DepartmentDevice> getDepartmentEdgeDevicedetail(Integer id) {
        return deviceMapper.getDepartmentEdgeDevicedetail(id);
    }

	/**
	 * @param departmentId
	 * @return
	 * @about get DepartmentsConfig File For Camera
	 */
	@Override
	public ResponseModel getDepartmentsConfigForCamera(Integer departmentId) {
	    // 1.校验门店是否存在
        Department department = departmentMapper.selectByPrimaryKey(departmentId);
        HashMap<Object, Object> hashMap = new HashMap<>();
        hashMap.put("whetherInstall",0);
        if(null != department){
            // 2.校验是否安装过  0 没有 1 已安装
            List<DepartmentDevice> departmentDevices = deviceMapper.selectByDepartmentId(departmentId);
            for(DepartmentDevice departmentDevice : departmentDevices){
                if(departmentDevice.getInstallStatus() == 1){
                    hashMap.put("whetherInstall",1);
                }
            }
            // 该门店下所有的摄像头部署文件
            List<HardwareDeploymentFile> hardwaresList = deviceHardwareMapper.selectAllEdgeDeviceHardwareByDeviceId(departmentId);
            hashMap.put("deploymentFile",hardwaresList);
            return ResponseModel.ok(hashMap);
        }else {
            return ResponseModel.fail("该门店不存在！", -1);
        }
	}
    /**
     * @return
     * @about get All DepartmentsConfig File For Camera
     */
    @Override
    public List<HardwareDeploymentFile> getAllDepartmentsConfigForCamera() {
        // 获取所有门店摄像头部署文件
        List<HardwareDeploymentFile> hardwaresList = deviceHardwareMapper.selectAllEdgeDeviceHardwareByDeviceId(null);
        return  removeDuplicateCase(hardwaresList);
    }

    /**
     * @param cases
     * @return list 去重
     */
    private List<HardwareDeploymentFile> removeDuplicateCase(List<HardwareDeploymentFile> cases) {
        Set<HardwareDeploymentFile> set = new TreeSet<>(new Comparator<HardwareDeploymentFile>() {
            @Override
            public int compare(HardwareDeploymentFile o1, HardwareDeploymentFile o2) {
                //字符串,则按照asicc码升序排列
                return o1.getdId().compareTo(o2.getdId());
            }
        });
        set.addAll(cases);
        return new ArrayList<>(set);
    }
    @Override
	public PageResult<Department> selectPageDepartment(PageRequest pageRequest, String name, String dCode) {
		int pageNum = pageRequest.getPageNum();
		int pageSize = pageRequest.getPageSize();
		PageHelper.startPage(pageNum, pageSize);
		List<Department> sysMenus = selectAllDepartment(name, dCode);
		return PageUtils.getPageResult(pageRequest, new PageInfo<Department>(sysMenus));
	}

	@Override
	public PageResult<DepartmentDevice> selectPageDepartmentDevice(Integer departmentId, String type,
			PageRequest pageRequest) {
		int pageNum = pageRequest.getPageNum();
		int pageSize = pageRequest.getPageSize();
		PageHelper.startPage(pageNum, pageSize);
		List<DepartmentDevice> sysMenus = selectAllDepartmentDevice();
		return PageUtils.getPageResult(pageRequest, new PageInfo<DepartmentDevice>(sysMenus));
	}
    @Override
    public List<Department> selectAllDepartment() {
        List<Department> sysMenus = selectAllDepartment(null, null);
        List<Integer> ids = new ArrayList<>();
        for(Department department : sysMenus){
            ids.add(department.getId());
        }
        List<DepartmentDeviceTopology> departmentDeviceTopology = topologyMapper.selectTopologyByDepartmentIds(ids);
        if(null != departmentDeviceTopology && !"".equals(departmentDeviceTopology)){
            for(Department department : sysMenus){
                for(DepartmentDeviceTopology deviceTopology : departmentDeviceTopology){
                    if(department.getId().equals(deviceTopology.getdId())){
                        if(null != deviceTopology.getData() && !"".equals(deviceTopology.getData())){
                            department.setData(deviceTopology.getData());
                        }
                    }
                }
            }
        }
        return sysMenus;
    }

	/**
	 * @param dId
	 * @return
     * @about 心跳机制<根据店铺id返回设备详情>
	 */
    @Override
    public List<EdgeDeviceStatusVo> selectEquipmentDetail(Integer dId) {
        List<DepartmentDevice> departmentDevices = edgeServiceImpl.selectEquipmentDetail(dId);
        List<EdgeDeviceStatusVo> edgeDeviceStatusVoList = new ArrayList<>();
        if(departmentDevices != null && departmentDevices.size() > 0){
            for(DepartmentDevice device : departmentDevices){
                EdgeDeviceStatusVo edgeDeviceStatusVo = new EdgeDeviceStatusVo();
                edgeDeviceStatusVo.setId(device.getId());
                edgeDeviceStatusVo.setName(device.getServerName());
                edgeDeviceStatusVo.setCode(device.getServerCode());
                edgeDeviceStatusVo.setStatus((device.getStatus()));
                SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm");
                String format = simpleDateFormat.format(new Date());
                edgeDeviceStatusVo.setDetectionDate(format);
                if(edgeDeviceStatusVo.getStatus() == 1){
                    edgeDeviceStatusVo.setErrorMsg(CommonParams.HEART_ERR_MSG);
                }
                edgeDeviceStatusVoList.add(edgeDeviceStatusVo);
            }
        }
        return edgeDeviceStatusVoList;
    }

    /**
     * @param lenovoToken
     * @about get jwttoken
     */
    @Override
    public ResponseModel getJwttoken(String lenovoToken) {
       // logger.info("get Jwttoken is {} " , lenovoToken);
        String result = restTemplate.getForObject(GET_JWT_TOKEN_URL+lenovoToken, String.class);
        ResponseModel responseModel = JSONObject.parseObject(result, ResponseModel.class);
       // logger.info("get Jwttoken result is {} " , responseModel );
        return responseModel;
    }

    /**
     * @param edgeDeviceStatusVoList
     * @return 心跳机制<每一分钟接收一次>
     */
    @Override
    public ResponseModel whetherDepartmentDeviceIsNormal(List<EdgeDeviceStatusVo> edgeDeviceStatusVoList) {
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        String format = simpleDateFormat.format(new Date());
        List<String> backKey = new ArrayList<>();
        HashMap<String, Object> hashMap = new HashMap<>();
        List<DepartmentDevice> deviceStatusVoList = new ArrayList<>();
        for(EdgeDeviceStatusVo edgeDeviceStatusVo : edgeDeviceStatusVoList){
            DepartmentDevice deviceStatusVo = new DepartmentDevice();
            deviceStatusVo.setServerCode(edgeDeviceStatusVo.getCode());
            deviceStatusVo.setStatus(0);
            String forValue = redisHelper.getForValue(edgeDeviceStatusVo.getCode());
            // 首次存入redis
            if(null != forValue && !"".equals(forValue)){
                Date date = TimeUtil.dateFormat(forValue);
                int timeInterval = TimeUtil.timeInterval(new Date(), date);
                if(timeInterval > 60 || edgeDeviceStatusVo.getStatus() != 0){  // 未接收到请求，状态为异常
                    deviceStatusVo.setStatus(1);
                }
                redisHelper.removeForValue(edgeDeviceStatusVo.getCode());
            }
            redisHelper.setForValue(edgeDeviceStatusVo.getCode() ,format);
            backKey.add(edgeDeviceStatusVo.getCode());
            deviceStatusVoList.add(deviceStatusVo);
        }
        if(null != deviceStatusVoList && deviceStatusVoList.size() > 0){
            deviceMapper.updateDeviceStatus(deviceStatusVoList);
        }

        hashMap.put("departmentDeviceKeyList",backKey);
        return ResponseModel.ok(hashMap);
    }

    /**
     * @return  controlService 发送消息说明agent 已上线
     */
    @Override
    public ResponseModel getNoticeForAgent(Integer storeId, Integer deviceId) {

        int result = softwareMapper.updateSoftwareConfigCanInit(storeId,deviceId);

        return ResponseModel.ok(result);
    }

    public HashMap<String,Object> initModelParam(Integer storeId, Integer deviceId,EdgeServerInitVo edgeServerInitvO){
        // TODO 之前使用id,目前更换成code
        Department department = departmentMapper.selectByPrimaryKey(storeId);
        DepartmentDevice departmentDevice = deviceMapper.selectByPrimaryKey(deviceId);
        ResponseModel responseResult = edgeServiceImpl.selectDeviceByTx2IdAndDepartmentId(department.getBtitdCode(), departmentDevice.getServerCode());
        // 单个模型init<过滤>
        HashMap<String,Object> hashMapForInit = (HashMap<String, Object>) responseResult.getResult();
        List<SoftwareForDevice> softwareList = (List<SoftwareForDevice>)hashMapForInit.get("allSoftwareList");
        SoftwareConfig softwareConfig = softwareMapper.selectModelScript(edgeServerInitvO.getModelCode());
        List<String> software = new ArrayList<>();
        List<SoftwareForDevice> softwareListNow = new ArrayList<>();

        SoftwareForDevice softwareForDevice = new SoftwareForDevice();
        software.add(edgeServerInitvO.getModelCode());
        softwareForDevice.setSoftwareConfigCode(software);
        for(SoftwareForDevice s : softwareList){
            if(s.getCode().equals(edgeServerInitvO.getSoftwareCode())){
                softwareForDevice.setName(s.getName());
                softwareForDevice.setUrl(s.getUrl());
                softwareForDevice.setId(s.getId());
                softwareForDevice.setVersion(softwareConfig.getVersion());
                softwareForDevice.setCode(s.getCode());
            }
        }
        softwareListNow.add(softwareForDevice);

        hashMapForInit.put("softwareList",softwareListNow);
        return hashMapForInit;
    }
    /**
     * @param storeId
     * @param deviceId
     * @return  init模型
     */
    public ResponseModel init(Integer storeId, Integer deviceId,EdgeServerInitVo edgeServerInitvO,HttpServletResponse response){
        ResponseModel responseResult = new ResponseModel();
        // 1.1 校验摄像头不可为空
        if(null == edgeServerInitvO.getCaremaList()){
            return ResponseModel.fail("请选择该模型下需要配置的摄像头！", -1);
        }
        // 1.2 校验摄像头匹配的模型是否正确
       /* SoftwareConfig softwareConfig = softwareMapper.selectModelScript(edgeServerInitvO.getModelCode());
        if(softwareConfig.getsName().contains(CommonParams.MODEL_SMARTSTORE)){
           if(edgeServerInitvO.getCaremaList().size() >= 2){
               return ResponseModel.fail("进店模型只支持一台设备！" , -1);
           }
        }*/
        // 1.3 校验是否可以初始化<安装摄像头校对图审核通过>
       /* List<DepartmentDevice> departmentDevices = deviceMapper.getDepartmentEdgeDevicedetail(storeId);
        for(DepartmentDevice departmentDevice :departmentDevices){
            if(departmentDevice.geteType().equals("edge")){
                continue;
            }
            if(departmentDevice.getInstallStatus() != 3){
                return ResponseModel.fail("存在摄像头未校对成功",-1);
            }
        }*/

        List<Integer> initCaremaList = edgeServerInitvO.getCaremaList();
        // 2 .组装单个模型(过滤已选择的摄像头)的数据
        HashMap<String, Object> hashMapForInit = initModelParam(storeId, deviceId, edgeServerInitvO);
        List<CaremaVo> caremaList  =  (List<CaremaVo>)hashMapForInit.get("cameraList");
        List<CaremaVo> caremaListNew  =  new ArrayList<>();
        for(Integer i : initCaremaList){
           for(CaremaVo caremaVo :caremaList){
               if(caremaVo.getCaremaId().equals(i)){
                   if(caremaVo.getCameraType() == 1){
                       if(caremaVo.getLineList().size() == 0){
                           // 1.4 校验是否可以初始化<进店摄像头进店线数据不可为空>
                           return ResponseModel.fail("进店摄像头画线数据不可为空！", -1 );
                       }
                   }
                   caremaListNew.add(caremaVo);
               }
           }
        }
        hashMapForInit.put("cameraList", caremaListNew);
        hashMapForInit.put("caremaList", caremaListNew);
        hashMapForInit.put("allCameraList", caremaList);
        int result = 0;
        // 3. 请求init服务
        responseResult = restTemplate.postForObject(CONTROL_SERVER_INIT+ "/aimigos/v1/project/"+storeId+"/device/"+deviceId+"/model/init/v1.1", hashMapForInit, ResponseModel.class);
        logger.info("init result  is {} ", responseResult.getMessage());
        // 4. 返回成功修改本地run脚本
        if(responseResult.getStatus() == 0){
            HashMap<String,Object> hashMap = (HashMap) responseResult.getResult();
            if(null != hashMap){
                List<ModelInitResult> modelInitResults = (List<ModelInitResult>)hashMap.get("softwareConfiglist");
                String agentConfig = (String)hashMap.get("agentConfig");
                if(modelInitResults.size() > 0 && null != modelInitResults){
                    result = softwareMapper.updateSoftwareConfig(modelInitResults,storeId,deviceId);
                }
                if(StringUtils.isNotBlank(agentConfig)){
                    deviceMapper.updateDeviceConfig(deviceId,agentConfig);
                }else{
                    return ResponseModel.fail("tx2 配置文件获取为空 ！", -1);
                }
            }
           // 5. 修改设备isconfig
          // deviceMapper.updateDeviceIsConfig(initCaremaList);
        }else{
            logger.error("controlServer init error ,message is {}", responseResult.getMessage());
            return responseResult;
        }
        return ResponseModel.ok(result);
    }

    /**
     * @param storeId
     * @param deviceId
     * @return run 服务
     */
    @Override
    public ResponseModel run(Integer storeId, Integer deviceId, EdgeServerInitVo edgeServerInitvO) {
        // 1.校验是否可以初始化<安装摄像头校对图审核通过>
       /*  List<DepartmentDevice> departmentDevices = deviceMapper.getDepartmentEdgeDevicedetail(storeId);
       for(DepartmentDevice departmentDevice :departmentDevices){
            if(departmentDevice.geteType().equals("edge")){
                continue;
            }
            if(departmentDevice.getInstallStatus() != 3){
                return ResponseModel.fail("存在摄像头未校对成功",-1);
            }
        }*/
        ResponseModel responseResult = new ResponseModel();
        // 2.查询启动脚本
        SoftwareConfig softwareConfig = softwareMapper.selectModelScript(edgeServerInitvO.getModelCode());
        String base64RunScript = "";
        if(StringUtils.isNotBlank(softwareConfig.getRunScript())){
            Base64 base64 = new Base64();
            try {
                base64RunScript = base64.encodeToString(softwareConfig.getRunScript().getBytes("UTF-8"));
            } catch (UnsupportedEncodingException e) {
                e.printStackTrace();
            }
            HashMap<String, Object> hashMapResult = new HashMap<>();
            hashMapResult.put("shell",base64RunScript);
            hashMapResult.put("run_type","now");
            hashMapResult.put("time","");
            hashMapResult.put("arg","");
            logger.info("start run model code is {}",edgeServerInitvO.getModelCode());
            // 调用run服务
            responseResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "api/aimigos/" + storeId + "/" + deviceId + "/model/run", hashMapResult, ResponseModel.class);
            if(responseResult.getStatus() != 0){
                logger.error("controlServer run error ,message is {}", responseResult.getMessage());
            }
        }else{
            return ResponseModel.fail("该模型执行脚本为空！",-1);
        }
        return responseResult;
    }

    @Override
    public List<EdgeServerDetail> getDeviceList(Integer departmentId) {
        Department department = departmentMapper.selectByPrimaryKey(departmentId);
        // 3.设备模型列表
        List<EdgeServerDetail> edgeServerDetailList = new ArrayList<>();
        List<EdgeServer> edgeServerList = new ArrayList<>();
        // 3.1 查找tx2
        List<DepartmentDeviceForBtit> edgeList = deviceMapper.selectDeviceByDepartmentId(departmentId, "edge");

        List<SoftwareConfig> softwareConfig = new ArrayList<>();
        for(DepartmentDeviceForBtit deviceForBtit :edgeList){
            List<SoftwareConfig> softwareConfigList = softwareMapper.selectSoftwareConfigAndSoftware(departmentId,deviceForBtit.getId());
            softwareConfig.addAll(softwareConfigList);
        }

        // 4.1 组装列表返回: 一级菜单设备列表（转换格式为一级二级菜单）
        for (int i = 0; i < edgeList.size(); i++) {
            EdgeServerDetail edgeServerDetail = new EdgeServerDetail();
            edgeServerDetail.setId(edgeList.get(i).getId());
            edgeServerDetail.setEdgeServerCode(edgeList.get(i).getDeviceCode());
            edgeServerDetail.setEdgeServerId(edgeList.get(i).getId());
            edgeServerDetail.setEdgeServerName(edgeList.get(i).getDeviceName());
            edgeServerDetail.setParentId(0);
            edgeServerDetailList.add(edgeServerDetail);
             // TODO 模型升级修改：
            // 4.2 组装列表返回: 二级菜单：根据模型类型分组
            List<SoftwareConfig> softwareConfigs = softwareMapper.selectSoftwareConfigAndSoftware(departmentId, edgeList.get(i).getId());
            Map<Integer, List<SoftwareConfig>> collect = softwareConfigs.stream().collect(Collectors.groupingBy(SoftwareConfig::getsId));
            Set<Integer> integers = collect.keySet();
            for(Integer l : integers){
                for(SoftwareConfig softwareConfig1 : softwareConfigs){
                    if(softwareConfig1.getsId().equals(l)){
                        EdgeServerDetail edgeServerDetail2 = new EdgeServerDetail();
                        edgeServerDetail2.setId((softwareConfig1.getsId() + softwareConfig1.getEdgeDeviceId()) * softwareConfig1.getEdgeDeviceId());
                        edgeServerDetail2.setEdgeServerId(softwareConfig1.getEdgeDeviceId());
                        edgeServerDetail2.setSoftwareCode(softwareConfig1.getsCode());
                        edgeServerDetail2.setModelName(softwareConfig1.getsName());
                        edgeServerDetail2.setModelDownUrl(softwareConfig1.getsUrl());
                        edgeServerDetail2.setParentId(softwareConfig1.getEdgeDeviceId());
                        // 3.2查询版本号
                        Software sCodeBean = softwareMapper.selectByCode(softwareConfig1.getsCode());
                        // 1 表示可升级
                        edgeServerDetail2.setFlag(sCodeBean.getVersion().equals(softwareConfig1.getVersion()) ? 0 : 1);
                        edgeServerDetail2.setVersion(softwareConfig1.getVersion());
                        if(!edgeServerDetailList.contains(edgeServerDetail2)){
                            edgeServerDetailList.add(edgeServerDetail2);
                        }
                    }
                }
            }
        }

        //  新增实例选择的摄像头
        List<DepartmentDeviceForBtit> departmentDevices = deviceMapper.selectDeviceByDepartmentId(departmentId, "end");
        List<CaremaPo> caremaList = new ArrayList<>();
        int flag = 0;
        for(DepartmentDeviceForBtit departmentDevice :departmentDevices){
            CaremaPo caremaPo = new CaremaPo();
            caremaPo.setCaremaId(departmentDevice.getId());
            caremaPo.setCaremaName(departmentDevice.getDeviceName());
            // 查询tx2的信息
            DepartmentDeviceTopology topology = topologyMapper.selectTopologyByDeviceId(departmentId, departmentDevice.getId());
            caremaPo.setEdgeServerId(topology.getFromDeviceId());
            if(StringUtils.isBlank(departmentDevice.getType())){
                flag = 1 ;
            }else{
                caremaPo.setCaremaType(Integer.parseInt(departmentDevice.getType()) == 1 ? CommonParams.CAMERA_USE_TYPE_1 : CommonParams.CAMERA_USE_TYPE_2);
                caremaList.add(caremaPo);
            }
        }
        int j = 0;
        // 4.3 组装列表返回: 三级级菜单设备列表
        if(softwareConfig.size() > 0 && null != softwareConfig){
            for(SoftwareConfig software :softwareConfig){
                if(software.getDelFlag() != 0){
                    continue;
                }
                EdgeServerDetail detail = new EdgeServerDetail();
                detail.setId(j);
                detail.setEdgeServerId(software.getEdgeDeviceId());
                for(DepartmentDeviceForBtit deviceForBtit : edgeList){
                    if(deviceForBtit.getId().equals(software.getEdgeDeviceId())){
                        detail.setEdgeServerName(deviceForBtit.getDeviceName());

                        String key = deviceForBtit.getDeviceCode() + "-" + software.getCode();
                        if(StringUtils.isNotBlank(key)){
                            String forValue = redisHelper.getForValue(key);
                            logger.info("model heartbeat , redis key {} , get value is {} " + key + forValue);
                            detail.setStatus(StringUtils.isNotBlank(forValue) ? forValue : CommonParams.DEPARTMENT_DEVICE_NOT_STATUS);
                        }
                    }
                }
                detail.setModelName(software.getsName());
                detail.setModelId(software.getId());
                detail.setModelCode(software.getCode());
                detail.setSoftwareCode(software.getsCode());
                detail.setModelDownUrl(software.getsUrl());
                detail.setCanInitFlag(software.getCanInitFlag());
                // 3.2查询版本号
                Software sCodeBean = softwareMapper.selectByCode(software.getsCode());
                // 1 表示可升级
                detail.setFlag(sCodeBean.getVersion().equals(software.getVersion()) ? 0 : 1);
                detail.setVersion(software.getVersion());
                detail.setParentId((software.getsId() + software.getEdgeDeviceId()) * software.getEdgeDeviceId());
                // 返回可选的摄像头：
                if(flag == 0){
                   /* if(detail.getModelName().contains(CommonParams.MODEL_SMARTSTORE)){
                        List<CaremaPo> newResult = caremaList
                                .stream().filter(a -> a.getCaremaType().equals(CommonParams.CAMERA_USE_TYPE_1)).collect(Collectors.toList())
                                .stream().filter(a -> a.getEdgeServerId().equals(detail.getEdgeServerId())).collect(Collectors.toList());
                        detail.setCaremaList(newResult);
                    }else{
                        List<CaremaPo> newResult = caremaList
                                .stream().filter(a -> a.getCaremaType().equals(CommonParams.CAMERA_USE_TYPE_2)).collect(Collectors.toList())
                                .stream().filter(a -> a.getEdgeServerId().equals(detail.getEdgeServerId())).collect(Collectors.toList());
                        detail.setCaremaList(newResult);
                    }*/
                    List<CaremaPo> newResult = caremaList
                            .stream().filter(a -> a.getEdgeServerId().equals(detail.getEdgeServerId())).collect(Collectors.toList());
                    detail.setCaremaList(newResult);
                }
                edgeServerDetailList.add(detail);
                j++;
            }
        }
        List<EdgeServerDetail> tree = TreeConfig.getTree2(edgeServerDetailList);
        return tree;
    }

    /**
     * @param deviceId ,modelId
     * @return 根据id查找配置详情
     */
    @Override
    public HashMap<String,Object> getConfig(String type,Integer deviceId) {
        HashMap<String, Object> hashMap = new HashMap<>();
        String serverConfig = "";
        if(!CommonParams.MODEL.equals(type)){
            DepartmentDevice departmentDevice = deviceMapper.selectByPrimaryKey(deviceId);
            serverConfig = departmentDevice.getServerConfig();
        }else{
            SoftwareConfig softwareConfig = softwareMapper.selectSoftwareConfigById(deviceId);
            serverConfig = softwareConfig.getContent();
        }
        hashMap.put("deviceConfig",serverConfig);
        return hashMap;
    }



    /**
     * @param softwareConfig
     * @param departmentId
     * @param deviceId
     * @return 添加实例
     */
    @Override
    public ResponseModel addModelConfig(EdgeServerDetail edgeServerDetail, Integer departmentId, Integer deviceId) {

        SoftwareConfig softwareConfig = new SoftwareConfig();
        String stopScript ="#!/bin/bash\n" +
                "\n" +
                "pid=`ps -ef |grep %s |grep -v 'grep'| awk '{ print $2 }'`;\n" +
                "\n" +
                "if [  -n  \"$pid\"  ];  then\n" +
                "   echo pid=$pid\n" +
                "   kill  $pid;\n" +
                "fi";
        softwareConfig.setdId(departmentId);
        softwareConfig.setEdgeDeviceId(deviceId);
        String content = "";
        String runScript = "";
        Software software = softwareMapper.selectByCode(edgeServerDetail.getSoftwareCode());
        List<SoftwareConfig> softwareConfigs = softwareMapper.selectSoftwareConfigForCanUse(departmentId, deviceId);
        for(SoftwareConfig software1 : softwareConfigs){
            if(software1.getsId().equals(software.getId())){
               content = software1.getContent();
               runScript = software1.getRunScript();
            }
        }
        softwareConfig.setsName(software.getFileName());
        softwareConfig.setsId(software.getId());
        softwareConfig.setVersion(software.getVersion());
        softwareConfig.setCanInitFlag(1);
        softwareConfig.setsUrl(software.getFilePath());
        softwareConfig.setsCode(software.getsCode());
        softwareConfig.setCode(UUID.randomUUID().toString().substring(0,8).replace("-","a").trim());
        softwareConfig.setStopScript(stopScript);
        softwareConfig.setContent(content);
        softwareConfig.setRunScript(runScript);

        int i = softwareMapper.insertSoftWareConfigBean(softwareConfig);
        if(i > 0){
            return ResponseModel.ok(softwareConfig);
        }else{
            return ResponseModel.fail("添加失败！",-1);
        }

    }

    /**
     * @param storeId
     * @param deviceId
     * @param edgeServerInitvO
     * @return 手动停止模型
     */
    @Override
    public ResponseModel stopModel(Integer storeId, Integer deviceId, EdgeServerInitVo edgeServerInitvO) {
        ResponseModel responseResult = new ResponseModel();
        // 1.查询停止脚本
        SoftwareConfig softwareConfig = softwareMapper.selectModelStopScript(edgeServerInitvO.getModelCode());
        if(null == softwareConfig){
            return ResponseModel.fail("模型不存在！", -1);
        }
        String replace = softwareConfig.getStopScript().replace("%s", edgeServerInitvO.getModelCode());
        String base64StopScript = "";
        if(StringUtils.isNotBlank(softwareConfig.getStopScript())){
            Base64 base64 = new Base64();
            try {
                base64StopScript = base64.encodeToString(replace.getBytes("UTF-8"));
            } catch (UnsupportedEncodingException e) {
                e.printStackTrace();
            }
            HashMap<String, Object> hashMapResult = new HashMap<>();
            hashMapResult.put("shell",base64StopScript);
            hashMapResult.put("run_type","now");
            hashMapResult.put("time","");
            hashMapResult.put("arg","");
            logger.info("start stop model code is {}",edgeServerInitvO.getModelCode());
            // 2.调用停止模型服务
            responseResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "api/aimigos/" + storeId  + "/" + deviceId + "/command/execute", hashMapResult, ResponseModel.class);
            if(responseResult.getStatus() != 0){
                logger.error("controlServer run error ,message is {}", responseResult.getMessage());
            }
        }else{
            return ResponseModel.fail("该模型执行脚本为空！",-1);
        }

        if(responseResult.getStatus() == 0){
            // 延迟查询
            logger.info("延时前:"+ new Date().toString());
            try {
                Thread.sleep(3000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            logger.info("延时后:"+ new Date().toString());
            HashMap hashMap = (HashMap) responseResult.getResult();
            ResponseModel responseModelResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "aimigos/v1/result", hashMap, ResponseModel.class);
            logger.info("seccessful stop server , select ststus is {} result is {} " + responseModelResult.getStatus() + responseModelResult.getResult());
            int length = DepartmentServiceImpl.getLength(responseModelResult.getResult());
            if(length < 2){
                return ResponseModel.fail(CommonParams.STOP_MODEL_FAIL,-1);
            }
        }else{
            logger.error("controlServer not first run error ,message is {}", responseResult.getMessage());
        }
        return responseResult;
    }

    /**
     * @param storeId
     * @param deviceId
     * @param edgeServerInitvO
     * @return 删除模型
     */
    @Override
    public ResponseModel deleteModel(Integer storeId, Integer deviceId, EdgeServerInitVo edgeServerInitvO) {
         // 是否运行中，如在使用需停止再删除
        String key = edgeServerInitvO.getSoftwareCode() + "-" + edgeServerInitvO.getModelCode();
        if(StringUtils.isNotBlank(key)){
            String forValue = redisHelper.getForValue(key);
            logger.info("model heartbeat , redis key {} , get value is {} " + key + forValue);
            if(StringUtils.isNotBlank(forValue)){
                if(forValue.equals(CommonParams.DEPARTMENT_DEVICE_STATUS)){
                    return ResponseModel.fail("请先停止服务再删除！",-1);
                }
            }
        }
        int i = softwareMapper.deleteModelById(edgeServerInitvO.getModelCode());
        return ResponseModel.ok(0);
    }

    @Override
    public ResponseModel updateEdgeDeviceConfig(EdgeDeviceConfig edgeDeviceConfig,  String deviceId) {
        StringBuilder config = new StringBuilder();
        config.append(edgeDeviceConfig.getDeviceConfig() + "\n" +
                "network:\n" + edgeDeviceConfig.getNetWork() +
                "\n" +
                "mac:\n" +
                edgeDeviceConfig.getMac());
        int i = deviceMapper.updateDeviceConfigByCode(deviceId, config.toString());
        if(i > 0){
            return ResponseModel.ok(i);
        }
        return ResponseModel.fail("更新失败", -1);
    }

    /**
     * @param type
     * @param installAndDeploy
     * @return  上传工具包
     */
    @Override
    public ResponseModel uploadInstrument(HardwareDeploymentFile hardwareDeploymentFile,MultipartFile file) {
        ResponseModel responseModel = resourceServiceImpl.uploadOSystem(file, CommonParams.HARDWARE_CONFIG_FILE);
        String deploymentFilePath = "";
        if(0 == responseModel.getStatus()){
            HashMap<String,String> map = (HashMap<String,String>)responseModel.getResult();
            String filePath = map.get(CommonParams.FILE_PATH);
            if(!org.springframework.util.StringUtils.isEmpty(filePath)){
                deploymentFilePath = filePath;
            }
            hardwareDeploymentFile.setDeploymentFileName(file.getOriginalFilename());
            hardwareDeploymentFile.setDeploymentFilePath(deploymentFilePath);
            hardwareDeploymentFile.setDeploymentFileSize(file.getSize());
        }
        hardwareDeploymentFile.setdId(-1);
        int i = 0;
        // 上传还是修改
        HardwareDeploymentFile oldHardwareDeploymentFile = hardwareMapper.selectHardwareInstrument(hardwareDeploymentFile.getType());
        if(null != oldHardwareDeploymentFile){
            i = hardwareMapper.updateHardwareInstrument(hardwareDeploymentFile);
        }else{
            i = hardwareMapper.insertHardwareDeploymentFile(hardwareDeploymentFile);
        }
        if(i > 0){
            return ResponseModel.ok(i);
        }
        return ResponseModel.fail("更新失败", -1);
    }

    /**
     * @param type
     * @return 查询工具包
     */
    @Override
    public ResponseModel selectInstrument(String type) {
        HardwareDeploymentFile hardwareDeploymentFile = hardwareMapper.selectHardwareInstrument(type);
        return ResponseModel.ok(hardwareDeploymentFile);
    }

    /**
     * @param type
     * @param storeId
     * @param deviceId
     * @param edgeServerInitvO
     * @return 修改配置
     */
    @Override
    public ResponseModel updateConfig(String type, Integer storeId, Integer deviceId, EdgeServerInitVo edgeServerInitvO) {

        HashMap<String, Object> hashMapResult = new HashMap<>();
        if(CommonParams.MODEL.equals(type)){
            hashMapResult.put("path","/opt/"+ edgeServerInitvO.getSoftwareCode() +"/"+ edgeServerInitvO.getVersion() +"/"+edgeServerInitvO.getModelCode());
        }else{
            hashMapResult.put("path","/opt/remora_agent/configs/config.yaml");
        }
        return modifyTheConfiguration(storeId, deviceId, edgeServerInitvO,hashMapResult,type);
    }

    /**
     * @param modelConfigLog
     * @param storeId
     * @param deviceId
     * @return  记录模型日志
     */
    @Override
    public ResponseModel insertModelConfigLog(ModelConfigLog modelConfigLog, Integer storeId, Integer deviceId) {
        if(null == modelConfigLog && StringUtils.isBlank(modelConfigLog.getContent())){
            return ResponseModel.fail("log content is null",-1);
        }
        modelConfigLog.setStoreId(storeId);
        modelConfigLog.setEdgeServerId(deviceId);
        modelConfigLog.setCreateTime(TimeUtil.getDateToString(modelConfigLog.getTimestamp()));
        softwareMapper.insertModelConfigLog(modelConfigLog);
        return ResponseModel.ok("success");
    }

    @Override
    public ResponseModel getLog(Integer departmentId, String startTime, String endTime) {
        List<ModelLog> modelLogs = departmentMapper.getLog(departmentId,startTime,endTime);
        return ResponseModel.ok(modelLogs);
    }

    /**
     * @param storeId
     * @param deviceId
     * @param edgeServerInitvO
     * @return 修改配置-- 模型
     */
    public ResponseModel modifyTheConfiguration(Integer storeId, Integer deviceId, EdgeServerInitVo edgeServerInitvO,HashMap<String, Object> hashMapResult,String type) {
        String base64RunScript = "";
        if(StringUtils.isNotBlank(edgeServerInitvO.getContent())){
            Base64 base64 = new Base64();
            try {
                base64RunScript = base64.encodeToString(edgeServerInitvO.getContent().getBytes("UTF-8"));
            } catch (UnsupportedEncodingException e) {
                e.printStackTrace();
            }
            hashMapResult.put("content",base64RunScript);
            logger.info("start update config, modelcode is {}",edgeServerInitvO.getModelCode());
            // 1. 调用修改配置
            ResponseModel responseResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "/aimigos/v1/project/" + storeId + "/device/" + deviceId+ "/init", hashMapResult, ResponseModel.class);
            if(responseResult.getStatus() == 0){
                //  2. 延迟查询
                logger.info("延时前:"+ new Date().toString());
                try {
                    Thread.sleep(3000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                logger.info("延时后:"+ new Date().toString());
                HashMap hashMap = (HashMap) responseResult.getResult();
                ResponseModel responseModelResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "aimigos/v1/result", hashMap, ResponseModel.class);
                logger.info("seccessful request reStsrt server , select ststus is {} result is {} " + responseModelResult.getStatus() + responseModelResult.getResult());
                int length = DepartmentServiceImpl.getLength(responseModelResult.getResult());
                // 3. 查询结果lenth>2 并且内置 status=0
                if(length >= 2){
                    List<LinkedHashMap<String,Object>> resultMaps = ( List<LinkedHashMap<String,Object>> )responseModelResult.getResult();
                    for(LinkedHashMap<String,Object> link : resultMaps){
                        Iterator it = link.entrySet().iterator();
                        while (it.hasNext()) {
                            Map.Entry entry = (Map.Entry) it.next();
                            if(entry.getKey().equals("message")){
                                LinkedHashMap<String,Object> value = (LinkedHashMap<String,Object>)entry.getValue();
                                if(value.keySet().contains("status")){
                                    int status = (int)value.get("status");
                                    if(status == 0){
                                        // 4. 成功调用后修改本地
                                        if(CommonParams.MODEL.equals(type)){
                                            softwareMapper.updateSoftwareConfigByModelCode(edgeServerInitvO.getModelCode(),edgeServerInitvO.getContent());
                                        }else {
                                            deviceMapper.updateDeviceConfig(deviceId,edgeServerInitvO.getContent());
                                        }
                                        return ResponseModel.ok(CommonParams.SELECT_RESULT_SUCCESS);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }else{
            return ResponseModel.fail(CommonParams.UPDATE_CONFIG_CONTENT_NULL,-1);
        }
        return ResponseModel.fail(CommonParams.SELECT_RESULT_FAIL,-1);
    }

    /**
     * @param serverStatus
     * @param ServerCode  "tx2_code -  software_code"
     * @return  controlService 发送消息 - 监控服务(模型)的状态  0 ：正常 1:异常
     */
    @Override
    public ResponseModel getHeartForServer(ServerStatus serverStatus) {

        List<ServerStatus> serverStatusList = serverStatus.getServerStatusList();

        try{
            if(null != serverStatusList && serverStatusList.size() > 0){
                for(ServerStatus status : serverStatusList){
                    String stu = status.getStatus() == 0 ? CommonParams.DEPARTMENT_DEVICE_STATUS : CommonParams.DEPARTMENT_DEVICE_NOT_STATUS;
                    redisHelper.setForValue(status.getServerCode(),stu);
                }
            }
        }catch (Exception e){
            logger.error("redis save error");
        }

        return ResponseModel.ok(0);
    }

    /**
     * @param name
     * @param storeId
     * @param deviceId
     * @return  手动重启模型
     */
    @Override
    public ResponseModel reStartToContrlServer(String name, Integer storeId, Integer deviceId) {
        // run 服务 -重启而已
        HashMap<String,Object> message = new HashMap<>();
        String[] split = name.split("\\.");
        message.put("name",split[0]);
        ResponseModel responseResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "aimigos/v1/project/" + storeId + "/device/" + deviceId + "/model/restart", message, ResponseModel.class);
        if(responseResult.getStatus() == 0){
            // 延迟查询
            logger.info("延时前:"+ new Date().toString());
            try {
                Thread.sleep(3000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            logger.info("延时后:"+ new Date().toString());
            HashMap hashMap = (HashMap) responseResult.getResult();
            ResponseModel responseModelResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "aimigos/v1/result", hashMap, ResponseModel.class);
            logger.info("seccessful request reStsrt server , select ststus is {} result is {} " + responseModelResult.getStatus() + responseModelResult.getResult());
            int length = DepartmentServiceImpl.getLength(responseModelResult.getResult());
            if(length < 2){
                return ResponseModel.fail(CommonParams.SELECT_RESULT_FAIL,1);
            }
        }else{
            logger.error("controlServer not first run error ,message is {}", responseResult.getMessage());
        }
        return responseResult;
    }
    /**
     * @param edgeServerInitvO,
     * @param storeId
     * @param deviceId
     * @return 模型升级
     */
    @Override
    public ResponseModel upgradeVersionForModel(Integer storeId, Integer deviceId, EdgeServerInitVo edgeServerInitvO, HttpServletResponse response) {

        // 通知controlServer 模型更新
        List<EdgeServerInitVo> edgeServerInitList = edgeServerInitvO.getEdgeServerInitList();
        
        int i = 0;
        for(EdgeServerInitVo edgeServerInit :edgeServerInitList){
            HashMap<String,Object> hashMap = new HashMap();
            hashMap.put("softwareCode", edgeServerInit.getSoftwareCode());
            hashMap.put("modelCode", edgeServerInit.getModelCode());

            Software software = softwareMapper.selectByCode(edgeServerInit.getSoftwareCode());
            hashMap.put("version",software.getVersion());
            hashMap.put("name",software.getFileName());
            hashMap.put("url", software.getFilePath());
            ResponseModel responseResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "aimigos/v1/project/" + storeId + "/device/" + deviceId + "/model/upgrade", hashMap, ResponseModel.class);
            if(responseResult.getStatus() != 0){
                logger.error("controlServer not first run error ,message is {}", responseResult.getMessage());
                return responseResult;
            }else{
                // 延迟查询
                logger.info("延时前:"+ new Date().toString());
                try {
                    Thread.sleep(1000 * 25);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                logger.info("延时后:"+ new Date().toString());
                HashMap hashMapResult = (HashMap) responseResult.getResult();
                ResponseModel responseModelResult = restTemplate.postForObject(CONTROL_SERVER_INIT + "aimigos/v1/result", hashMapResult, ResponseModel.class);
                logger.info("seccessful update software model package, select ststus is {} result is {} " + responseModelResult.getStatus() + responseModelResult.getResult());
                int length = DepartmentServiceImpl.getLength(responseModelResult.getResult());
                if(length < 2){
                    response.setStatus(500);
                    return ResponseModel.fail(CommonParams.SELECT_RESULT_FAIL,1);
                }
            }
            // 成功后修改本地版本号
            i = softwareMapper.updateVersion(storeId,deviceId,software.getId(),software.getVersion(),software.getFileName(),software.getFilePath());
        }

        return ResponseModel.ok(i);
    }
    /**
     * @param storeId
     * @param deviceId
     * @return 手动重启tx2
     */
    @Override
    public ResponseModel reStartTx2(Integer storeId, Integer deviceId) {

        HashMap<String,Object> message = new HashMap<>();
        message.put("run_type","now");
        message.put("shell","IyEvYmluL2Jhc2gKL3NiaW4vcmVib290Cg==");
        message.put("time","");
        message.put("arg","");
        // 1. 重启tx2
        restTemplate.postForObject(CONTROL_SERVER_INIT + "api/aimigos/" + storeId  + "/" + deviceId + "/command/execute", message, ResponseModel.class);
        // 延迟启动模型
        logger.info("延时前:"+ new Date().toString());
        try {
            Thread.sleep(2000 * 60);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        logger.info("延时后:"+ new Date().toString());

        // 2. 重启tx2关联所有模型
        List<SoftwareConfig> softwareConfigs = softwareMapper.selectSoftwareConfigForCanUse(storeId, deviceId);

        for(SoftwareConfig so : softwareConfigs){
            EdgeServerInitVo edgeServerInitvO = new EdgeServerInitVo();
            edgeServerInitvO.setSoftwareCode(so.getsCode());
            edgeServerInitvO.setModelCode(so.getCode());
            run( storeId, deviceId, edgeServerInitvO);
        }

        return ResponseModel.ok("重启服务完成");
    }

    /**
     * @param storeId
     * @param deviceId
     * @return 手动修改进店线配置
     */
    @Override
    public ResponseModel updateLineIntotheShop(Integer storeId, Integer deviceId,EdgeServerInitVo edgeServerInitvO) {

        ResponseModel responseModel = new ResponseModel();
        // 1.校验是否可以初始化<安装摄像头校对图审核通过>
        List<DepartmentDevice> departmentDevices = deviceMapper.getDepartmentEdgeDevicedetail(storeId);
        for(DepartmentDevice departmentDevice :departmentDevices){
            if(departmentDevice.geteType().equals("edge")){
                continue;
            }
            if(departmentDevice.getInstallStatus() != 3){
                return ResponseModel.fail("存在摄像头未校对成功",-1);
            }
        }

        HashMap<String, Object> smartStoreAddHashmap = initModelParam(storeId, deviceId, edgeServerInitvO);
       /* HashMap<String, Object> sendAddHashmap = new HashMap<>();
        HashMap<String, Object> smartStoreAddHashmap = new HashMap<>();

        smartStoreAddHashmap.put("softwareCode",edgeServerInitvO.getSoftwareCode());
        smartStoreAddHashmap.put("modelCode",edgeServerInitvO.getModelCode());
        // 1.查询设备信息
        DepartmentDevice departmentDevice = deviceMapper.selectByDepartmentIdAndDeviceId(storeId,deviceId);
        // 2.BtitdCode
        Department department = departmentMapper.selectByPrimaryKey(storeId);


        // 3.修改进店摄像头的画线数据的相关配置
        HashMap<String, Object> hashMap2 = selectDepartmentInstallFile(storeId,null);
        // 3.获取摄像头画图线数据
        if(null != hashMap2.get(departmentDevice.getId().toString())){
            HashMap<String, Object> oldValue = JSONObject.parseObject(hashMap2.get(departmentDevice.getId().toString()).toString(), HashMap.class);
            if(null != oldValue.get("url") && null != oldValue.get("lineList")){
                String url = (String) oldValue.get("url");

                List<CameraCoordinates> lineList = JSONArray.parseArray(oldValue.get("lineList").toString(), CameraCoordinates.class);
                for(CameraCoordinates cameraCoordinates : lineList){
                    if(cameraCoordinates.getLineType() == 0){
                        // 进店摄像头的数据 - 视频流地址
                        sendAddHashmap.put("video_source",url);
                        sendAddHashmap.put("sid",department.getBtitdCode());
                        sendAddHashmap.put("eid",deviceId);
                        sendAddHashmap.put("cid",departmentDevice.getId());

                        // 进店摄像头的画线数据
                        ControlServerCameraLineList cameraLineList1 = new ControlServerCameraLineList();
                        int[] lineStart = {(int)cameraCoordinates.getStartX(),(int)cameraCoordinates.getStartY()};
                        int[] lineEnd = {(int)cameraCoordinates.getEndX(),(int)cameraCoordinates.getEndY()};
                        int[] directionStart = {(int)cameraCoordinates.getArrowsStartX(),(int)cameraCoordinates.getArrowsStartY()};
                        int[] directionEnd = {(int)cameraCoordinates.getArrowsEndX(),(int)cameraCoordinates.getArrowsEndY()};
                        cameraLineList1.setLineStart(lineStart);
                        cameraLineList1.setLineEnd(lineEnd);
                        cameraLineList1.setDirectionEnd(directionStart);
                        cameraLineList1.setDirectionStart(directionEnd);

                        smartStoreAddHashmap.put("ENTER_JUDGMENT",cameraLineList1);
                        smartStoreAddHashmap.put("SEND",sendAddHashmap);
                    }
                }
            }
        }*/
        // 4.发送controlServer
        if( null != smartStoreAddHashmap){
             responseModel = restTemplate.postForObject(CONTROL_SERVER_INIT + "aimigos/v1/project/"+ storeId +"/device/"+ deviceId +"/model/changeConfig", smartStoreAddHashmap, ResponseModel.class);
            if(responseModel.getStatus() != 0) {
                logger.error("controlServer not first run error ,message is {}", responseModel.getMessage());
            }else {
                // 更新配置文件备份，执行脚本
                List<ModelInitResult> modelInitResults = (List<ModelInitResult>) responseModel.getResult();
                if(modelInitResults.size() > 0 && null != modelInitResults){
                   softwareMapper.updateSoftwareConfig(modelInitResults,storeId,deviceId);
                }
                // 修改成功后重启
                run(storeId, deviceId, edgeServerInitvO);
            }
        }

        return responseModel;
    }


}
